<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coupled Oscillators — Interactive Charts</title>

<!-- Libraries -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root { --pad:14px; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b0c10; color:#e8e8e8; }
  header { position:sticky; top:0; z-index:20; background:#111217; border-bottom:1px solid #222; padding:var(--pad); }
  h1 { margin:0 0 4px; font-size:20px; }
  .muted { color:#9aa3b2; font-size:12px; }

  .wrap { display:grid; grid-template-columns:360px 1fr; gap:16px; padding:var(--pad); height:calc(100vh - 64px); }
  .card { background:#14161d; border:1px solid #1f2330; border-radius:12px; box-shadow:0 0 0 1px #0b0c10 inset; display:flex; flex-direction:column; min-height:0; }
  .card > .body { padding:var(--pad); overflow:auto; }

  label { display:block; font-size:12px; color:#cfd3dc; margin:6px 0 6px; }
  textarea, input, button { width:100%; box-sizing:border-box; font:inherit; padding:8px; border-radius:8px; border:1px solid #2b3245; background:#0f1117; color:#e8e8e8; }
  textarea { min-height:84px; resize:vertical; }
  button { cursor:pointer; transition:background .15s,border-color .15s,box-shadow .15s; }
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:6px; }
  .viewbar { display:flex; gap:8px; align-items:center; }
  .viewbar button { width:auto; padding-inline:12px; }
  button.active { background:#1d2433 !important; border-color:#3a4a6a !important; box-shadow:0 0 0 2px rgba(110,168,254,.35); }

  /* Plots pane owns its own scroll area */
  .plots .body { overflow:auto; }
  .row { display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  .row.cols1 { grid-template-columns:1fr; }
  .row.cols2 { grid-template-columns:1fr 1fr; }
  .row.cols3 { grid-template-columns:1fr 1fr 1fr; }
  .panel { background:#0f1117; border:1px solid #242b3a; border-radius:10px; padding:10px; }
  .plot { width:100%; min-height:520px; }

  /* Plot text wrapping / clipping fixes */
  .js-plotly-plot .gtitle { white-space:normal !important; }
  .js-plotly-plot .main-svg { overflow:visible !important; }

  @media (max-width:960px){
    .wrap { grid-template-columns:1fr; height:auto; }
    .plots { order:-1; }
  }
</style>
</head>
<body>
<header>
  <h1>Coupled Oscillators — Interactive Charts</h1>
  <div class="muted">Header & controls stay fixed. Graphs have their own scroll area. Double-click a plot to fullscreen.</div>
</header>

<div class="wrap">
  <!-- Controls -->
  <div class="card controls">
    <div class="body">
      <h3 style="margin:0 0 8px">Startup Box — Quick X/Y</h3>
      <label>X values (comma/space/newline-separated)</label>
      <textarea id="xvals" placeholder="e.g., 1, 2, 3, 4"></textarea>
      <label>Y values (same length as X)</label>
      <textarea id="yvals" placeholder="e.g., 2, 4, 3, 6"></textarea>
      <div class="grid-2">
        <button id="btn-scatter">Make Scatter</button>
        <button id="btn-line">Make Connected Line</button>
      </div>

      <hr style="border-color:#1f2330; margin:14px 0">

      <h3 style="margin:0 0 8px">Upload CSVs</h3>
      <label>Hare–Lynx CSV (flexible headers: Year/Hare/Lynx)</label>
      <input type="file" id="file-hl" accept=".csv" />
      <label>Fitbit/time CSV (flexible: timestamp/time + steps/value)</label>
      <input type="file" id="file-fitbit" accept=".csv" />
      <label>Tribolium CSV (flexible: t/index/time + Adults/population/value)</label>
      <input type="file" id="file-trib" accept=".csv" />

      <div class="grid-2" style="margin-top:8px">
        <button id="btn-make-lynx">Phase & Return (HL)</button>
        <button id="btn-make-fitbit">Rose & Radar</button>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <button id="btn-make-trib">Cobweb (Tribolium)</button>
        <button id="btn-clear">Clear Plots</button>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <button id="btn-clear-files">Clear Files</button>
        <span class="muted" style="align-self:center">Files never leave your device.</span>
      </div>

      <p id="status" class="muted" style="margin:10px 0 0"></p>
    </div>
  </div>

  <!-- Plots -->
  <div class="card plots">
    <div class="body">
      <div class="toolbar">
        <div class="viewbar">
          <span class="muted">View:</span>
          <button id="view-1">1-up</button>
          <button id="view-2" class="active">2-up</button>
          <button id="view-3">3-up</button>
        </div>
        <div class="muted">Use the camera icon on any chart to download a PNG.</div>
      </div>

      <div id="plot-row" class="row cols2">
        <div class="panel"><div id="plot1" class="plot"></div></div>
        <div class="panel"><div id="plot2" class="plot"></div></div>
        <div class="panel"><div id="plot3" class="plot"></div></div>
        <div class="panel"><div id="plot4" class="plot"></div></div>
        <div class="panel"><div id="plot5" class="plot"></div></div>
        <div class="panel"><div id="plot6" class="plot"></div></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================= Utilities ============================= */
const config = { responsive:true, displaylogo:false };

function setStatus(msg,isError=false){
  const el = document.getElementById('status');
  if (!el) return;
  el.style.color = isError ? '#ffb4b4' : '#cfd3dc';
  el.textContent = msg;
}
function flash(btn){ btn.classList.add('active'); setTimeout(()=>btn.classList.remove('active'), 400); }

function toNumber(v){
  if (v === null || v === undefined) return null;
  if (typeof v === 'number' && Number.isFinite(v)) return v;
  let s = String(v).trim(); if (!s) return null;
  // remove thousands separators/spaces
  s = s.replace(/(?<=\d)[\s,](?=\d)/g,'');
  // percentage
  const pct = /%$/.test(s); s = s.replace(/%$/,'');
  const n = Number(s);
  return Number.isFinite(n) ? (pct ? n/100 : n) : null;
}
const toNumberArray = arr => arr.map(toNumber).filter(v=>v!==null);

function toDate(val){
  if (val===null || val===undefined || val==='') return null;
  if (val instanceof Date && !isNaN(val)) return val;
  if (typeof val === 'number'){
    const ms = val >= 1e12 ? val : (val >= 1e9 ? val*1000 : val);
    const d = new Date(ms); return isNaN(d) ? null : d;
  }
  const s = String(val).trim();
  let d = new Date(s); if (!isNaN(d)) return d;
  d = new Date(s.replace(/-/g,'/')); return isNaN(d) ? null : d;
}

function normKey(k){ return String(k||'').toLowerCase().replace(/[^a-z0-9]+/g,'').trim(); }
function pickColumn(rows, opts, {fallbackNumeric=false}={}){
  if (!rows || !rows.length) return null;
  const map = {}; Object.keys(rows[0]).forEach(k => map[normKey(k)] = k);
  for (const opt of opts){ const nk = normKey(opt); if (nk in map) return map[nk]; }
  if (fallbackNumeric){
    for (const c of Object.keys(rows[0])){
      const sample = rows.slice(0, Math.min(30, rows.length)).map(r=>toNumber(r[c]));
      if (sample.filter(v=>v!==null).length >= Math.ceil(sample.length*0.6)) return c;
    }
  }
  return null;
}

function readCSV(file, cb){
  Papa.parse(file, {
    header:true, skipEmptyLines:true, dynamicTyping:false,
    complete: res => { 
      if (res.errors?.length) setStatus('CSV warnings: '+res.errors[0].message, true);
      else setStatus(`Loaded ${file.name} (${res.data.length} rows)`);
      cb(res.data);
    },
    error: err => setStatus('CSV parse error: '+err, true)
  });
}

function baseLayout(title, extra={}){
  return Object.assign({
    title:{ text:title, x:0.02, xanchor:'left', font:{size:16} },
    margin:{ t:60, r:30, b:60, l:70 },
    xaxis:{ title:{text:''}, automargin:true, tickfont:{size:11}, titlefont:{size:12} },
    yaxis:{ title:{text:''}, automargin:true, tickfont:{size:11}, titlefont:{size:12} },
    hoverlabel:{ font:{size:11} }
  }, extra);
}
function polarLayout(title, extra={}){
  return Object.assign({
    title:{ text:title, x:0.02, xanchor:'left', font:{size:16} },
    margin:{ t:60, r:30, b:40, l:30 },
    polar:{
      angularaxis:{ direction:'clockwise', tickfont:{size:11} },
      radialaxis:{ tickfont:{size:11}, angle:0, ticks:'outside' }
    },
    hoverlabel:{ font:{size:11} }
  }, extra);
}

function clearPlots(){ for (let i=1;i<=6;i++) Plotly.purge('plot'+i); setStatus('Cleared.'); }
function clearFiles(){ ['file-hl','file-fitbit','file-trib'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';}); setStatus('Cleared chosen files.'); }

/* ========================== View / Fullscreen ========================== */
const rowEl = document.getElementById('plot-row');
const v1 = document.getElementById('view-1'), v2 = document.getElementById('view-2'), v3 = document.getElementById('view-3');
const viewBtns = [v1,v2,v3];
function setCols(n){ rowEl.classList.remove('cols1','cols2','cols3'); rowEl.classList.add('cols'+n); }
function setActive(btn){ viewBtns.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
v1.onclick=()=>{ setCols(1); setActive(v1); };
v2.onclick=()=>{ setCols(2); setActive(v2); };
v3.onclick=()=>{ setCols(3); setActive(v3); };
setCols(2);

for (let i=1;i<=6;i++){
  const el = document.getElementById('plot'+i);
  el.addEventListener('dblclick', () => {
    const wrap = document.createElement('div');
    wrap.style.position='fixed'; wrap.style.inset='0'; wrap.style.zIndex='9999';
    wrap.style.background='rgba(11,12,16,.98)'; wrap.innerHTML='<div id="fs" style="width:min(95vw,1200px);height:min(90vh,900px);margin:32px auto"></div>';
    document.body.appendChild(wrap);
    const data = el.data ? JSON.parse(JSON.stringify(el.data)) : [];
    const layout = el.layout ? JSON.parse(JSON.stringify(el.layout)) : {};
    Plotly.newPlot('fs', data, layout, {responsive:true,displaylogo:false});
    wrap.addEventListener('click', e=>{ if(e.target===wrap) wrap.remove(); });
    document.addEventListener('keydown', function esc(ev){ if(ev.key==='Escape'){ wrap.remove(); document.removeEventListener('keydown', esc);} });
  });
}

/* ============================ Quick X/Y ============================ */
function parseSeries(text){ if(!text) return []; return toNumberArray(text.replace(/[;,\t\r\n]+/g,' ').trim().split(/\s+/)); }

document.getElementById('btn-scatter').onclick = function(){
  flash(this);
  const xs=parseSeries(document.getElementById('xvals').value);
  const ys=parseSeries(document.getElementById('yvals').value);
  if (xs.length!==ys.length || xs.length<2) return setStatus('X and Y must be same length (≥2).', true);
  Plotly.newPlot('plot1',
    [{x:xs,y:ys,mode:'markers',type:'scatter'}],
    baseLayout('Custom Scatter (X vs Y)', { xaxis:{title:{text:'X'}}, yaxis:{title:{text:'Y'}} }),
    config
  );
};

document.getElementById('btn-line').onclick = function(){
  flash(this);
  const xs=parseSeries(document.getElementById('xvals').value);
  const ys=parseSeries(document.getElementById('yvals').value);
  if (xs.length!==ys.length || xs.length<2) return setStatus('X and Y must be same length (≥2).', true);
  Plotly.newPlot('plot1',
    [{x:xs,y:ys,mode:'lines+markers',type:'scatter'}],
    baseLayout('Custom Connected Line (X vs Y)', { xaxis:{title:{text:'X'}}, yaxis:{title:{text:'Y'}} }),
    config
  );
};

/* ================== Hare–Lynx (phase + return) ================== */
document.getElementById('btn-make-lynx').onclick = function(){
  flash(this);
  const f = document.getElementById('file-hl').files[0];
  if (!f) return setStatus('Upload a hare–lynx CSV first.', true);
  readCSV(f, rows => {
    const cy = pickColumn(rows, ['Year','year','date','yr'], {fallbackNumeric:true});
    const ch = pickColumn(rows, ['Hare','hare','hares','prey','harecount'], {fallbackNumeric:true});
    const cl = pickColumn(rows, ['Lynx','lynx','predator','lynxcount'], {fallbackNumeric:true});
    if (!cy || !ch || !cl) return setStatus('Couldn’t find Year/Hare/Lynx columns.', true);

    // clean & sort by year
    let T = rows.map(r=>({ y:toNumber(r[cy]), h:toNumber(r[ch]), l:toNumber(r[cl]) }))
                .filter(r=>r.y!==null && r.h!==null && r.l!==null)
                .sort((a,b)=>a.y-b.y);
    if (T.length<3) return setStatus('Need ≥ 3 numeric rows.', true);

    const year=T.map(r=>r.y), hare=T.map(r=>r.h), lynx=T.map(r=>r.l);
    const order=year.map((_,i)=>i);

    // Phase plane — colorbar OUTSIDE + extra right margin
    Plotly.newPlot('plot2', [
      { x:hare, y:lynx, mode:'lines', line:{width:1.8}, name:'path' },
      { x:hare, y:lynx, mode:'markers', name:'time',
        marker:{
          size:6, color:order, colorscale:'Blues', showscale:true,
          colorbar:{ title:{text:'order'}, thickness:12, len:0.9, x:1.07, xpad:8, y:0.5, ypad:8 }
        }
      }
    ],
    baseLayout('Phase Plane: Hare vs Lynx', {
      margin:{t:60,r:110,b:60,l:70},
      xaxis:{ title:{text:'Hare(t)'}, tickformat:',~s' },
      yaxis:{ title:{text:'Lynx(t)'}, tickformat:',~s' },
      legend:{ orientation:'h', x:0.02, y:1.08 }
    }), config);

    // Return maps with x=y diagonal and simple smoothing (moving average on sorted pairs)
    function retPlot(x, name, el){
      const x0 = x.slice(0,-1).map(v=>v);
      const x1 = x.slice(1).map(v=>v);
      // diagonal limits
      const lo = Math.min(...x0, ...x1), hi = Math.max(...x0, ...x1);
      const diag = { x:[lo,hi], y:[lo,hi], mode:'lines', line:{dash:'dot'}, hoverinfo:'skip', showlegend:false };

      // crude LOWESS-like: sort by x0 then moving avg on x1
      const idx = x0.map((v,i)=>[v,x1[i]]).sort((a,b)=>a[0]-b[0]);
      const sX = idx.map(r=>r[0]), sY = idx.map(r=>r[1]);
      const k = Math.max(3, Math.round(sX.length*0.1));
      const smX=[], smY=[];
      for (let i=0;i<sX.length;i++){
        const a=Math.max(0,i-k), b=Math.min(sX.length-1,i+k);
        smX.push(sX[i]);
        smY.push(sY.slice(a,b+1).reduce((p,c)=>p+c,0)/(b-a+1));
      }

      Plotly.newPlot(el, [
        { x:x0, y:x1, mode:'markers', name:name },
        { x:smX, y:smY, mode:'lines', name:'smooth', line:{width:2, color:'#f59e42'} },
        diag
      ], baseLayout(`Return: ${name}(t) → ${name}(t+1)`, {
        xaxis:{ title:{text:`${name}(t)`}, tickformat:',~s' },
        yaxis:{ title:{text:`${name}(t+1)`}, tickformat:',~s' },
        margin:{ t:60, r:30, b:60, l:70 }
      }), config);
    }
    retPlot(hare, 'Hare', 'plot3');
    retPlot(lynx, 'Lynx', 'plot4');

    setStatus('Rendered phase plane and return maps (year-sorted).');
  });
};

/* ======================= Fitbit (rose + radar) ======================= */
document.getElementById('btn-make-fitbit').onclick = function(){
  flash(this);
  const f = document.getElementById('file-fitbit').files[0];
  if (!f) return setStatus('Upload a Fitbit/time CSV first.', true);
  readCSV(f, rows => {
    const ct = pickColumn(rows, ['timestamp','time','datetime','date','ActivityMinute'], {fallbackNumeric:false});
    const cs = pickColumn(rows, ['steps','value','count','activity','stepcount','Steps'], {fallbackNumeric:true});
    if (!ct || !cs) return setStatus('Couldn’t find time & steps columns.', true);

    const byHour = new Array(24).fill(0);
    const dowSum = new Array(7).fill(0);
    const dowN   = new Array(7).fill(0);

    for (const r of rows){
      const d = toDate(r[ct]); if (!d) continue;
      const v = toNumber(r[cs]); if (v===null) continue;
      byHour[d.getHours()] += v;
      const di = (d.getDay()+6)%7; // Mon=0
      dowSum[di] += v; dowN[di] += 1;
    }

    // --- Nightingale Rose with 24-hour ticks (0–23h labels) ---
    const thetaDeg = [...Array(24).keys()].map(h => (h+0.5)*(360/24)); // mid-hour bins
    const hourTickVals = [...Array(24).keys()].map(h => h*(360/24));
    const hourTickText = [...Array(24).keys()].map(h => `${h}h`);
    Plotly.newPlot('plot5',
      [{ type:'barpolar', r:byHour, theta:thetaDeg, width:new Array(24).fill(360/24), name:'value' }],
      polarLayout('Nightingale Rose: Value by Hour', {
        polar:{
          angularaxis:{
            direction:'clockwise',
            tickmode:'array',
            tickvals:hourTickVals,
            ticktext:hourTickText,
            rotation:90   // 0h at top
          }
        }
      }),
      config
    );

    // --- Radar: share of steps by weekday (% of weekly total) ---
    const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const totals = dowSum.reduce((p,c)=>p+c,0) || 1;
    const share  = dowSum.map(s => 100*s/totals);
    Plotly.newPlot('plot6',
      [{ type:'scatterpolar',
         r:share.concat([share[0]]),
         theta:labels.concat([labels[0]]),
         mode:'lines+markers', fill:'toself', name:'% share' }],
      polarLayout('Radar: Mean Steps Share by Day of Week'),
      config
    );

    setStatus('Rendered Nightingale rose (24h ticks) and radar (weekday share).');
  });
};

/* ======================= Tribolium (cobweb) ======================= */
document.getElementById('btn-make-trib').onclick = function(){
  flash(this);
  const f = document.getElementById('file-trib').files[0];
  if (!f) return setStatus('Upload a Tribolium CSV first.', true);
  readCSV(f, rows => {
    const cv = pickColumn(rows, ['adults','count','population','value','n'], {fallbackNumeric:true});
    if (!cv) return setStatus('Couldn’t find Adults/population column.', true);

    const series = toNumberArray(rows.map(r=>r[cv]));
    if (series.length < 3) return setStatus('Need ≥ 3 numeric rows.', true);
    const x = series.slice(0,-1), y = series.slice(1);

    // Quadratic fit a + b*x + c*x^2 via normal equations
    const n=x.length; let Sx=0,Sx2=0,Sx3=0,Sx4=0,Sy=0,Sxy=0,Sx2y=0;
    for (let i=0;i<n;i++){ const xi=x[i], yi=y[i], x2=xi*xi; Sx+=xi; Sx2+=x2; Sx3+=x2*xi; Sx4+=x2*x2; Sy+=yi; Sxy+=xi*yi; Sx2y+=x2*yi; }
    function solve3(A,B){ const M=A.map((r,i)=>r.concat([B[i]])); const m=M.length;
      for(let k=0;k<m;k++){ let p=k; for(let i=k+1;i<m;i++) if(Math.abs(M[i][k])>Math.abs(M[p][k])) p=i;
        [M[k],M[p]]=[M[p],M[k]]; const piv=M[k][k]||1e-12;
        for(let j=k;j<=m;j++) M[k][j]/=piv;
        for(let i=0;i<m;i++) if(i!==k){ const f=M[i][k]; for(let j=k;j<=m;j++) M[i][j]-=f*M[k][j]; } }
      return M.map(r=>r[m]);
    }
    const [a,b,c] = solve3([[n,Sx,Sx2],[Sx,Sx2,Sx3],[Sx2,Sx3,Sx4]],[Sy,Sxy,Sx2y]);

    // Ricker fit y = x * exp(r * (1 - x/K))
    function fitRicker(x, y){
      // Avoid zeros; simple linearization on ln(y/x) = r*(1-x/K)
      const pairs = x.map((xi,i)=>[xi, y[i]]).filter(p=>p[0]>0 && p[1]>0);
      const X = pairs.map(p=>p[0]), L = pairs.map(p=>Math.log(p[1]/p[0]));
      const n=X.length; let Sx=0,Sx2=0,Sy=0,Sxy=0;
      for (let i=0;i<n;i++){ Sx+=X[i]; Sx2+=X[i]*X[i]; Sy+=L[i]; Sxy+=X[i]*L[i]; }
      const r = (n*Sxy - Sx*Sy) / (n*Sx2 - Sx*Sx + 1e-12);
      const a0 = (Sy - r*Sx)/n;               // a0 = r (since L = r - r/K * x) -> intercept ≈ r
      const r_est = a0;
      const K_est = -r_est / (r - 1e-12);
      return { r:r_est, K:K_est };
    }
    const rk = fitRicker(x,y);

    const lo=Math.min(...x,...y), hi=Math.max(...x,...y);
    const xs=Array.from({length:400},(_,i)=> lo+(hi-lo)*i/399);
    const fxQuad=xs.map(v=> a + b*v + c*v*v);
    const fxRick=xs.map(v=> v*Math.exp(rk.r*(1 - v/(rk.K||1e-12))));

    // Cobweb base + two model curves
    const traces = [
      { x, y, mode:'markers', name:'data', marker:{size:4} },
      { x:xs, y:fxQuad, mode:'lines', name:'Quadratic' },
      { x:xs, y:fxRick, mode:'lines', name:'Ricker', line:{dash:'dash'} },
      { x:[lo,hi], y:[0,0], mode:'lines', line:{color:'#666'}, hoverinfo:'skip', showlegend:false },
      { x:[0,0], y:[lo,hi], mode:'lines', line:{color:'#666'}, hoverinfo:'skip', showlegend:false }
    ];

    Plotly.newPlot('plot1', traces,
      baseLayout('Cobweb (map fit) – Tribolium', {
        xaxis:{ title:{text:'x(t)'} }, yaxis:{ title:{text:'x(t+1)'} },
        margin:{t:60,r:30,b:60,l:70}
      }),
      config
    );

    setStatus('Rendered cobweb with Quadratic + Ricker fits.');
  });
};

/* ===================== Buttons: clear / files ===================== */
document.getElementById('btn-clear').onclick = ()=>{ flash(document.getElementById('btn-clear')); clearPlots(); };
document.getElementById('btn-clear-files').onclick = ()=>{ flash(document.getElementById('btn-clear-files')); clearFiles(); };
</script>
</body>
</html>




