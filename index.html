<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Coupled Oscillators — Predator–Prey (Mites)</title>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root { --pad: 14px; }
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0c10;color:#e8e8e8}
header{padding:var(--pad);border-bottom:1px solid #222;background:#111217;position:sticky;top:0;z-index:10}
h1{margin:0 0 6px;font-size:20px}
.card{background:#14161d;border:1px solid #1f2330;border-radius:12px;padding:var(--pad)}
label{display:block;font-size:12px;margin-bottom:6px;color:#cfd3dc}
input,button{width:100%;box-sizing:border-box;font:inherit;padding:8px;border-radius:8px;border:1px solid #2b3245;background:#0f1117;color:#e8e8e8}
button{cursor:pointer}
.wrap{display:grid;gap:16px;grid-template-columns:320px 1fr;padding:var(--pad)}
@media (max-width:900px){.wrap{grid-template-columns:1fr}}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:8px}
.viewbar{display:inline-flex;gap:8px}
.viewbar button{width:auto;padding:6px 10px}
.row{display:grid;gap:16px;grid-template-columns:1fr 1fr}
.row.cols1{grid-template-columns:1fr}
.row.cols3{grid-template-columns:1fr 1fr 1fr}
.plot{min-height:520px;width:100%}
.js-plotly-plot .gtitle{white-space:normal!important}
button.active{background:#1d2433;border-color:#3a4a6a;box-shadow:0 0 0 2px rgba(110,168,254,.35)}
small.muted{color:#9aa3b2}
</style>
</head>
<body>
<header>
  <h1>Coupled Oscillators — Predator–Prey (Mites)</h1>
  <div class="toolbar">
    <div class="viewbar">
      <span class="muted">View:</span>
      <button id="v1">1-up</button>
      <button id="v2" class="active">2-up</button>
      <button id="v3">3-up</button>
    </div>
    <small class="muted">Tip: double-click a plot to zoom full, or use the camera icon to save a PNG.</small>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3 style="margin-top:0">Load mites (predator–prey) CSV</h3>
    <label>File (headers flexible: time/t, prey, predator)</label>
    <input type="file" id="file-pp" accept=".csv"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <button id="btn-run">Plot Phase & Returns</button>
      <button id="btn-clear">Clear Plots</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="chk-smooth" checked/> Show smoothed path</label>
      <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="chk-lv" checked/> Overlay Lotka–Volterra fit + orbit</label>
      <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="chk-log"/> Log scale axes</label>
      <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="chk-dots" checked/> Show points by time</label>
    </div>
    <div id="status" style="margin-top:10px;font-size:12px;color:#cfd3dc"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Figures</h3>
    <div id="msg" class="muted" style="font-size:12px;margin-bottom:6px"></div>
    <div id="plots" class="row cols2">
      <div id="p1" class="plot"></div>
      <div id="p2" class="plot"></div>
      <div id="p3" class="plot"></div>
    </div>
  </div>
</div>

<script>
const config = {responsive:true, displaylogo:false};

function setCols(n){
  const row = document.getElementById('plots');
  row.classList.remove('cols1','cols2','cols3');
  row.classList.add(n===1 ? 'cols1' : (n===3 ? 'cols3' : 'cols2'));
}
document.getElementById('v1').onclick = e => { setCols(1); setActive(e.target); };
document.getElementById('v2').onclick = e => { setCols(2); setActive(e.target); };
document.getElementById('v3').onclick = e => { setCols(3); setActive(e.target); };
function setActive(btn){
  for (const b of [v1,v2,v3]) b.classList.remove('active');
  btn.classList.add('active');
}
setCols(2);

function setStatus(s, bad=false){
  const el = document.getElementById('status');
  el.style.color = bad ? '#ffb4b4' : '#cfd3dc';
  el.textContent = s;
}

function readCSV(file){
  return new Promise((resolve,reject)=>{
    Papa.parse(file, {
      header:true, skipEmptyLines:true,
      complete: res => res.errors?.length ? reject(res.errors[0].message) : resolve(res.data),
      error: err => reject(err)
    });
  });
}
function normKey(k){return String(k||'').toLowerCase().replace(/[^a-z0-9]+/g,'').trim();}
function pickColumn(rows, opts){
  const map = {}; Object.keys(rows[0]).forEach(k=> map[normKey(k)] = k);
  for (const o of opts){ const nk = normKey(o); if (nk in map) return map[nk]; }
  return null;
}
function toNum(v){
  if (v==null || v==='') return null;
  if (typeof v==='number' && Number.isFinite(v)) return v;
  const s = String(v).replace(/(?<=\d)[,\s](?=\d)/g,'');
  const n = Number(s); return Number.isFinite(n) ? n : null;
}
function toDate(v){
  if (v==null || v==='') return null;
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v==='number'){ const d = new Date(v>=1e12?v: v>=1e9?v*1000:v); return isNaN(d)?null:d; }
  const s=String(v); let d=new Date(s); if(!isNaN(d)) return d; d=new Date(s.replace(/-/g,'/')); return isNaN(d)?null:d;
}
function baseLayout(title, extra={}){
  return Object.assign({
    title:{text:title, x:0.02, xanchor:'left', font:{size:16}},
    margin:{t:50,r:25,b:60,l:70},
    xaxis:{title:{text:''}, automargin:true, tickfont:{size:11}},
    yaxis:{title:{text:''}, automargin:true, tickfont:{size:11}},
    hoverlabel:{font:{size:11}}
  }, extra);
}
function diagTrace(x,y){
  const lo = Math.min(...x, ...y), hi = Math.max(...x, ...y);
  return {x:[lo,hi], y:[lo,hi], mode:'lines', line:{dash:'dot'}, hoverinfo:'skip', showlegend:false};
}

/* ---------- smoothing + interpolation ---------- */
function rollingMean(arr, w=3){
  if (arr.length<=w) return arr.slice();
  const half = Math.floor(w/2), out=[];
  for (let i=0;i<arr.length;i++){
    const a=Math.max(0,i-half), b=Math.min(arr.length-1,i+half);
    let s=0,c=0; for (let j=a;j<=b;j++){ s+=arr[j]; c++; }
    out.push(s/c);
  }
  return out;
}
function interpolateSeries(x, y, k=200){
  // monotone param t = 0..1
  const n=x.length; if(n<2) return {xi:x, yi:y};
  const t = Array.from({length:n},(_,i)=>i/(n-1));
  const xi=[], yi=[]; 
  for (let j=0;j<k;j++){
    const u=j/(k-1);
    let i=0; while(i<n-2 && !(t[i]<=u && u<=t[i+1])) i++;
    const a=(u-t[i])/(t[i+1]-t[i] || 1);
    xi.push(x[i]*(1-a)+x[i+1]*a);
    yi.push(y[i]*(1-a)+y[i+1]*a);
  }
  return {xi, yi};
}

/* ---------- LV fit from data + simulation ---------- */
function fitLV(prey, pred, dt=1){
  // dx/dt = aX - bXY;  dy/dt = -cY + dXY
  const n = Math.min(prey.length, pred.length);
  if (n<3) return null;
  const dX=[], dY=[], X=[], XY=[], Y=[];
  for (let i=0;i<n-1;i++){
    const x=prey[i], y=pred[i];
    if (!(x>0 && y>0)) continue;
    dX.push((prey[i+1]-prey[i])/dt);
    dY.push((pred[i+1]-pred[i])/dt);
    X.push(x); Y.push(y); XY.push(x*y);
  }
  if (X.length<3) return null;
  // Solve least squares: dX = [X, -XY] [a,b]^T;  dY = [-Y, XY] [c,d]^T
  function lsq(A,b){
    // normal eq (A^T A) p = A^T b, 2x2
    const s11=A.reduce((s,r)=>s+r[0]*r[0],0);
    const s12=A.reduce((s,r)=>s+r[0]*r[1],0);
    const s22=A.reduce((s,r)=>s+r[1]*r[1],0);
    const t1 =A.reduce((s,r,i)=>s+r[0]*b[i],0);
    const t2 =A.reduce((s,r,i)=>s+r[1]*b[i],0);
    const det=s11*s22-s12*s12 || 1e-12;
    return [( t1*s22 - t2*s12)/det, (s11*t2 - s12*t1)/det];
  }
  const A1 = X.map((x,i)=>[x, -XY[i]]);
  const A2 = Y.map((y,i)=>[-y, XY[i]]);
  const [a,b] = lsq(A1, dX);
  const [c,d] = lsq(A2, dY);
  return {a,b,c,d};
}
function simulateLV(params, x0, y0, steps=600, dt=0.05){
  const {a,b,c,d} = params;
  const xs=[x0], ys=[y0];
  for (let i=0;i<steps;i++){
    const x=xs[xs.length-1], y=ys[ys.length-1];
    const dx = a*x - b*x*y;
    const dy = -c*y + d*x*y;
    xs.push(Math.max(1e-9, x + dx*dt));
    ys.push(Math.max(1e-9, y + dy*dt));
  }
  return {xs, ys};
}

/* ---------- main: load + plot ---------- */
document.getElementById('btn-run').onclick = async () => {
  const f = document.getElementById('file-pp').files[0];
  if (!f){ setStatus('Choose a predator–prey CSV first.', true); return; }

  try{
    const rows = await readCSV(f);
    if (!rows.length){ setStatus('CSV has no rows.', true); return; }

    const colT = pickColumn(rows, ['time','t','date','step','index']);
    const colPrey = pickColumn(rows, ['prey','preycount','prey_n','prey_num','preycount']);
    const colPred = pickColumn(rows, ['predator','pred','predcount','predatorcount','predators']);
    if (!colPrey || !colPred) { setStatus('Could not find prey & predator columns.', true); return; }

    // Extract & sort by time if present
    let T = rows.map((r,i)=>({
      t: colT ? (toDate(r[colT])?.getTime() ?? toNum(r[colT]) ?? i) : i,
      prey: toNum(r[colPrey]),
      pred: toNum(r[colPred])
    })).filter(r=>r.prey!=null && r.pred!=null).sort((a,b)=>a.t-b.t);

    // Deduplicate time and keep monotone
    const prey = T.map(r=>r.prey), pred = T.map(r=>r.pred);
    const idx = T.map((_,i)=>i);
    const showDots = document.getElementById('chk-dots').checked;
    const logScale = document.getElementById('chk-log').checked;

    // Phase plane — raw path
    const phase = [{x:prey, y:pred, mode:'lines', name:'path'}];
    if (showDots){
      phase.push({x:prey, y:pred, mode:'markers', name:'time',
                  marker:{size:6, color:idx, colorscale:'Blues'},
                  showlegend:true});
    }

    // Smoothed path
    if (document.getElementById('chk-smooth').checked && prey.length>=5){
      const px = rollingMean(prey, 5);
      const py = rollingMean(pred, 5);
      const {xi, yi} = interpolateSeries(px, py, 300);
      phase.push({x:xi, y:yi, mode:'lines', name:'smooth', line:{width:2, color:'#8fd3ff'}});
    }

    // LV fit + simulated orbit
    let msg = `Loaded ${T.length} rows. `;
    if (document.getElementById('chk-lv').checked && prey.length>=6){
      const p = fitLV(prey, pred, 1);
      if (p){
        msg += `LV fit: a=${p.a.toFixed(3)}, b=${p.b.toFixed(4)}, c=${p.c.toFixed(3)}, d=${p.d.toFixed(4)}.`;
        const startI = Math.floor(prey.length*0.2);
        const sim = simulateLV(p, prey[startI], pred[startI], 800, 0.03);
        phase.push({x:sim.xs, y:sim.ys, mode:'lines', name:'LV orbit', line:{dash:'dash', width:2, color:'#ffa94d'}});
      } else {
        msg += 'LV fit skipped (not enough usable points).';
      }
    } else if (prey.length<6) {
      msg += 'Consider adding more time points for a clearer loop.';
    }
    document.getElementById('msg').textContent = msg;

    const xyLayout = baseLayout('Phase Plane: Prey vs Predator', {
      xaxis:{title:{text:'Prey(t)'}, type: logScale?'log':'linear', tickformat: logScale?'.2s':',~s'},
      yaxis:{title:{text:'Predator(t)'}, type: logScale?'log':'linear', tickformat: logScale?'.2s':',~s'},
      legend:{orientation:'h'}
    });
    Plotly.newPlot('p1', phase, xyLayout, config);

    // Return maps (prey & predator)
    const xP = prey.slice(0,-1), yP = prey.slice(1);
    const xQ = pred.slice(0,-1), yQ = pred.slice(1);
    function lsLine(x,y){
      const n=x.length; if(n<2) return {m:1,b:0};
      let sx=0, sy=0, sxy=0, sxx=0;
      for (let i=0;i<n;i++){ sx+=x[i]; sy+=y[i]; sxy+=x[i]*y[i]; sxx+=x[i]*x[i]; }
      const m = (n*sxy - sx*sy)/(n*sxx - sx*sx || 1e-12);
      const b = (sy - m*sx)/n;
      return {m,b};
    }
    const fitP = lsLine(xP,yP), fitQ = lsLine(xQ,yQ);
    const diagP = diagTrace(xP,yP), diagQ = diagTrace(xQ,yQ);
    const xpSpan = [Math.min(...xP), Math.max(...xP)];
    const xqSpan = [Math.min(...xQ), Math.max(...xQ)];

    Plotly.newPlot('p2', [
      {x:xP, y:yP, mode:'markers', name:'Return'},
      {x:xpSpan, y:xpSpan.map(v=>fitP.m*v+fitP.b), mode:'lines', name:'LS fit', line:{color:'#6bd17b'}},
      Object.assign({}, diagP, {name:'x=y', line:{dash:'dot', color:'#ffa94d'}})
    ], baseLayout('Return: Prey(t) → Prey(t+1)', {
      xaxis:{title:{text:'Prey(t)'}, type: logScale?'log':'linear', tickformat: logScale?'.2s':',~s'},
      yaxis:{title:{text:'Prey(t+1)'}},
      legend:{orientation:'h'}
    }), config);

    Plotly.newPlot('p3', [
      {x:xQ, y:yQ, mode:'markers', name:'Return'},
      {x:xqSpan, y:xqSpan.map(v=>fitQ.m*v+fitQ.b), mode:'lines', name:'LS fit', line:{color:'#6bd17b'}},
      Object.assign({}, diagQ, {name:'x=y', line:{dash:'dot', color:'#ffa94d'}})
    ], baseLayout('Return: Predator(t) → Predator(t+1)', {
      xaxis:{title:{text:'Predator(t)'}, type: logScale?'log':'linear', tickformat: logScale?'.2s':',~s'},
      yaxis:{title:{text:'Predator(t+1)'}},
      legend:{orientation:'h'}
    }), config);

    setStatus('Done.');
  } catch(err){
    console.error(err);
    setStatus('CSV parse error: '+err, true);
  }
};

document.getElementById('btn-clear').onclick = ()=>{
  for (const id of ['p1','p2','p3']) Plotly.purge(id);
  setStatus('Cleared.');
};
</script>
</body>
</html>






