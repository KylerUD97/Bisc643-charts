<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Coupled Oscillators — Interactive Charts</title>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --pad: 14px; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:#0b0c10; color:#e8e8e8; }
  header { padding:var(--pad); border-bottom:1px solid #222; background:#111217; position:sticky; top:0; z-index:10; }
  h1 { margin:0 0 6px; font-size:20px; }
  .muted { color:#9aa3b2; font-size:12px; }
  .wrap { display:grid; gap:16px; grid-template-columns:360px 1fr; padding:var(--pad); }
  .card { background:#14161d; border:1px solid #1f2330; border-radius:12px; padding:var(--pad); }
  .card h2 { font-size:16px; margin:0 0 8px; }
  textarea,input,button { width:100%; box-sizing:border-box; font:inherit; padding:8px; border-radius:8px; border:1px solid #2b3245; background:#0f1117; color:#e8e8e8; }
  textarea { min-height:80px; resize:vertical; }
  button { cursor:pointer; transition: background .15s, border-color .15s, box-shadow .15s; }
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
  .toolbar { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin:6px 0 10px; }
  .viewbar { display:inline-flex; gap:8px; align-items:center; }
  .viewbar button { width:auto; padding-inline:10px; }
  .row { display:grid; gap:16px; grid-template-columns:1fr 1fr; }
  .row.cols1 { grid-template-columns:1fr; }
  .row.cols2 { grid-template-columns:1fr 1fr; }
  .row.cols3 { grid-template-columns:1fr 1fr 1fr; }
  .plot { min-height:520px; width:100%; }
  .row.cols1 .plot { min-height:640px; }
  .js-plotly-plot .gtitle { white-space:normal !important; }
  .js-plotly-plot .main-svg { overflow:visible !important; }
  button.active { background:#1d2433 !important; border-color:#3a4a6a !important; box-shadow:0 0 0 2px rgba(110,168,254,.35); }
  @media (max-width: 900px) { .wrap{ grid-template-columns:1fr } }
  .opt { display:grid; grid-template-columns:auto 1fr; gap:6px 10px; align-items:center; font-size:12px; color:#cfd3dc; margin-top:8px; }
</style>
</head>
<body>
<header>
  <h1>Coupled Oscillators — Interactive Charts</h1>
  <div class="muted">Header & controls stay fixed. Graphs have their own scroll area. Double-click a plot to fullscreen.</div>
</header>

<div class="wrap">
  <!-- CONTROLS -->
  <div class="card">
    <h2>Startup Box — Quick X/Y</h2>
    <label>X values (comma/space/newline-separated)</label>
    <textarea id="xvals" placeholder="e.g., 1, 2, 3, 4"></textarea>
    <label>Y values (same length as X)</label>
    <textarea id="yvals" placeholder="e.g., 2, 4, 3, 6"></textarea>
    <div class="grid-2">
      <button id="btn-scatter">Make Scatter</button>
      <button id="btn-line">Make Connected Line</button>
    </div>
    <hr style="border-color:#1f2330; margin:14px 0">

    <h2>Upload CSVs</h2>

    <label>Hare–Lynx CSV (headers flexible: Year/Hare/Lynx)</label>
    <input type="file" id="file-hl" accept=".csv"/>

    <label>Fitbit by-minute CSV (flexible: timestamp/time + steps/value)</label>
    <input type="file" id="file-fitbit" accept=".csv"/>

    <label>Tribolium CSV (flexible: t/index/time + Adults/population/value)</label>
    <input type="file" id="file-trib" accept=".csv"/>

    <label>Mites Predator–Prey CSV (headers flexible: time/t + prey + predator)</label>
    <input type="file" id="file-mites" accept=".csv"/>

    <div class="grid-2" style="margin-top:8px">
      <button id="btn-make-lynx">Phase & Return (HL)</button>
      <button id="btn-make-fitbit">Rose & Radar</button>
    </div>
    <div class="grid-2" style="margin-top:8px">
      <button id="btn-make-trib">Cobweb (Tribolium)</button>
      <button id="btn-make-mites">Mites: Phase & Returns</button>
    </div>

    <div class="grid-2" style="margin-top:8px">
      <button id="btn-clear">Clear Plots</button>
      <button id="btn-clear-files">Clear Files</button>
    </div>

    <div class="opt">
      <input type="checkbox" id="opt-smooth" checked/>
      <label for="opt-smooth">Mites: show smoothed phase-plane path</label>
      <input type="checkbox" id="opt-lv" checked/>
      <label for="opt-lv">Mites: overlay Lotka–Volterra model orbit (fit)</label>
      <input type="checkbox" id="opt-log" />
      <label for="opt-log">Mites: log scale axes (phase-plane)</label>
      <input type="checkbox" id="opt-timepts" checked/>
      <label for="opt-timepts">Mites: color points by time</label>
    </div>

    <p class="muted" style="margin-top:10px">Tip: Use the camera icon on any plot to download a PNG.</p>
  </div>

  <!-- PLOTS -->
  <div class="card" style="display:flex; flex-direction:column; min-height:80vh;">
    <div class="toolbar">
      <div class="viewbar">
        <span class="muted">View:</span>
        <button id="view-1">1-up</button>
        <button id="view-2" class="active">2-up</button>
        <button id="view-3">3-up</button>
      </div>
      <div class="muted">Use the camera icon on any chart to download a PNG.</div>
    </div>
    <div id="status" class="muted" style="margin:4px 0 8px; color:#e3e7ef;"></div>

    <div id="plot-row" class="row cols2" style="overflow:auto; padding-right:2px">
      <div id="plot1" class="plot"></div>
      <div id="plot2" class="plot"></div>
      <div id="plot3" class="plot"></div>
      <div id="plot4" class="plot"></div>
      <div id="plot5" class="plot"></div>
      <div id="plot6" class="plot"></div>
    </div>
  </div>
</div>

<script>
/* ============================ helpers ============================ */
const config = { responsive: true, displaylogo: false };

function setStatus(msg, isError=false){
  const el = document.getElementById("status");
  el.style.color = isError ? "#ffb4b4" : "#e3e7ef";
  el.textContent = msg;
}
function setCols(n){ const r=document.getElementById("plot-row"); r.className = "row cols"+n; }
document.getElementById("view-1").onclick = e=>{ setCols(1); setActive(e.target,[view1,view2,view3]); };
document.getElementById("view-2").onclick = e=>{ setCols(2); setActive(e.target,[view1,view2,view3]); };
document.getElementById("view-3").onclick = e=>{ setCols(3); setActive(e.target,[view1,view2,view3]); };
const view1=document.getElementById("view-1"), view2=document.getElementById("view-2"), view3=document.getElementById("view-3");

function setActive(el, group){
  group.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
  el.classList.add('active'); el.setAttribute('aria-pressed','true');
}
function flash(el, ms=300){ el.classList.add('active'); setTimeout(()=>el.classList.remove('active'), ms); }
function scrollToPlots(){ document.getElementById('plot-row').scrollTop = 0; }

function toNumber(v){
  if (v===null || v===undefined) return null;
  if (typeof v==="number" && Number.isFinite(v)) return v;
  let s = String(v).trim(); if (!s) return null;
  s = s.replace(/(?<=\d)[\s,](?=\d)/g,"");         // 12,345 or 12 345 -> 12345
  const pct = /%$/.test(s); s=s.replace(/%$/,"");
  const n = Number(s);
  return Number.isFinite(n) ? (pct ? n/100 : n) : null;
}
const toNumberArray = arr => arr.map(toNumber).filter(v=>v!==null);
function toDate(val){
  if (val===null||val===undefined||val==="") return null;
  if (val instanceof Date && !isNaN(val)) return val;
  if (typeof val==="number"){
    const ms = val>=1e12?val : (val>=1e9? val*1000 : val);
    const d=new Date(ms); return isNaN(d)?null:d;
  }
  const s=String(val).trim();
  let d=new Date(s); if (!isNaN(d)) return d;
  d=new Date(s.replace(/-/g,'/')); return isNaN(d)?null:d;
}
function normKey(k){ return String(k||"").toLowerCase().replace(/[^a-z0-9]+/g,"").trim(); }
function pickColumn(rows, opts, {fallbackNumeric=false} = {}){
  if (!rows?.length) return null;
  const map={}; Object.keys(rows[0]).forEach(k=> map[normKey(k)] = k);
  for (const opt of opts){ const nk=normKey(opt); if (nk in map) return map[nk]; }
  if (fallbackNumeric){
    for (const c of Object.keys(rows[0])){
      const vals = rows.slice(0,Math.min(30,rows.length)).map(r=>toNumber(r[c]));
      if (vals.filter(v=>v!==null).length >= Math.ceil(vals.length*0.6)) return c;
    }
  }
  return null;
}
function readCSV(file, cb){
  Papa.parse(file,{header:true,skipEmptyLines:true,
    complete: res=>{ if(res.errors?.length){ setStatus("CSV warnings: "+res.errors[0].message, true); } else setStatus(`Loaded ${file.name} (${res.data.length} rows)`); cb(res.data); },
    error: err=> setStatus("CSV parse error: "+err, true)
  });
}

/* cubic Hermite interpolation (monotone-ish) */
function interp1(x, y, segN=20){
  const n=x.length, m=new Array(n).fill(0);
  for(let i=1;i<n-1;i++){
    const dx1=x[i]-x[i-1], dx2=x[i+1]-x[i];
    const s1=(y[i]-y[i-1])/dx1, s2=(y[i+1]-y[i])/dx2;
    m[i] = (s1*s2<=0)?0:2/(1/s1+1/s2);
  }
  m[0]=(y[1]-y[0])/(x[1]-x[0]); m[n-1]=(y[n-1]-y[n-2])/(x[n-1]-x[n-2]);
  const xs=[], ys=[];
  for(let i=0;i<n-1;i++){
    const x0=x[i], x1=x[i+1], y0=y[i], y1=y[i+1], h=x1-x0, m0=m[i], m1=m[i+1];
    for(let k=0;k<segN;k++){
      const t=k/segN, t2=t*t, t3=t2*t;
      const h00= 2*t3-3*t2+1, h10=t3-2*t2+t, h01=-2*t3+3*t2, h11=t3-t2;
      xs.push(x0+t*h); ys.push(h00*y0+h10*h*m0+h01*y1+h11*h*m1);
    }
  }
  xs.push(x[n-1]); ys.push(y[n-1]); return {xs,ys};
}
function addDiag(x,y){ // 1:1 dashed
  const min=Math.min(...x,...y), max=Math.max(...x,...y);
  return {x:[min,max], y:[min,max], mode:"lines", line:{dash:"dot",width:1}, hoverinfo:"skip", showlegend:false};
}

/* ============== Quick X/Y ============== */
function parseSeries(text){ if (!text) return []; return toNumberArray(text.replace(/[;,\t\r\n]+/g," ").trim().split(/\s+/)); }
document.getElementById("btn-scatter").onclick = function(){
  flash(this);
  const xs=parseSeries(document.getElementById("xvals").value);
  const ys=parseSeries(document.getElementById("yvals").value);
  if (xs.length!==ys.length || xs.length<2) return setStatus("X and Y must be same length (≥2).", true);
  Plotly.newPlot("plot1", [{x:xs,y:ys,mode:"markers"}],
    {title:{text:"Custom Scatter (X vs Y)",x:0.02}, margin:{t:50,l:60,r:20,b:60}, xaxis:{title:"X"}, yaxis:{title:"Y"}}, config );
  setStatus("Rendered custom scatter."); scrollToPlots();
};
document.getElementById("btn-line").onclick = function(){
  flash(this);
  const xs=parseSeries(document.getElementById("xvals").value);
  const ys=parseSeries(document.getElementById("yvals").value);
  if (xs.length!==ys.length || xs.length<2) return setStatus("X and Y must be same length (≥2).", true);
  Plotly.newPlot("plot1", [{x:xs,y:ys,mode:"lines+markers"}],
    {title:{text:"Custom Connected Line (X vs Y)",x:0.02}, margin:{t:50,l:60,r:20,b:60}, xaxis:{title:"X"}, yaxis:{title:"Y"}}, config );
  setStatus("Rendered custom connected line."); scrollToPlots();
};

/* ============== Hare–Lynx (phase + returns) ============== */
document.getElementById("btn-make-lynx").onclick = function(){
  flash(this);
  const f=document.getElementById("file-hl").files[0];
  if(!f) return setStatus("Upload a hare–lynx CSV first.", true);
  readCSV(f, rows=>{
    const colYear=pickColumn(rows,["Year","date","yr"],{fallbackNumeric:true});
    const colHare=pickColumn(rows,["Hare","hare","prey","hares"],{fallbackNumeric:true});
    const colLynx=pickColumn(rows,["Lynx","lynx","predator"],{fallbackNumeric:true});
    if(!colYear||!colHare||!colLynx) return setStatus("Couldn’t find Year/Hare/Lynx columns.", true);

    let T=rows.map(r=>({y:toNumber(r[colYear]), h:toNumber(r[colHare]), l:toNumber(r[colLynx])}))
              .filter(r=>r.y!==null&&r.h!==null&&r.l!==null)
              .sort((a,b)=>a.y-b.y);
    if (T.length<3) return setStatus("Need ≥3 numeric rows.", true);

    const year=T.map(r=>r.y), hare=T.map(r=>r.h), lynx=T.map(r=>r.l), idx=year.map((_,i)=>i);

    // Phase plane
    Plotly.newPlot("plot2",
      [
        {x:hare,y:lynx,mode:"lines",name:"path",line:{width:2}},
        {x:hare,y:lynx,mode:"markers",name:"time",
         marker:{size:6, color:idx, colorscale:"Blues", showscale:true, colorbar:{title:"order", x:1.08}}}
      ],
      {title:{text:"Phase Plane: Hare vs Lynx",x:0.02},
       margin:{t:50,l:70,r:60,b:60}, xaxis:{title:"Hare(t)", tickformat:",~s"}, yaxis:{title:"Lynx(t)", tickformat:",~s"},
       legend:{orientation:"h"}}, config);

    // Returns
    const ht=hare.slice(0,-1), ht1=hare.slice(1), lt=lynx.slice(0,-1), lt1=lynx.slice(1);
    Plotly.newPlot("plot3",
      [{x:ht,y:ht1,mode:"markers",name:"Hare"}, addDiag(ht,ht1)],
      {title:{text:"Return: Hare(t) → Hare(t+1)",x:0.02}, margin:{t:50,l:70,r:20,b:60},
       xaxis:{title:"Hare(t)", tickformat:",~s"}, yaxis:{title:"Hare(t+1)", tickformat:",~s"}}, config);
    Plotly.newPlot("plot4",
      [{x:lt,y:lt1,mode:"markers",name:"Lynx"}, addDiag(lt,lt1)],
      {title:{text:"Return: Lynx(t) → Lynx(t+1)",x:0.02}, margin:{t:50,l:70,r:20,b:60},
       xaxis:{title:"Lynx(t)", tickformat:",~s"}, yaxis:{title:"Lynx(t+1)", tickformat:",~s"}}, config);

    setStatus("Rendered Hare–Lynx phase & returns."); scrollToPlots();
  });
};

/* ============== Fitbit (Nightingale 24-hour & weekly radar) ============== */
document.getElementById("btn-make-fitbit").onclick = function(){
  flash(this);
  const f=document.getElementById("file-fitbit").files[0];
  if(!f) return setStatus("Upload a Fitbit/time CSV first.", true);
  readCSV(f, rows=>{
    const colTime=pickColumn(rows,["timestamp","time","datetime","date","ActivityMinute"],{fallbackNumeric:false});
    const colSteps=pickColumn(rows,["steps","value","count","activity","Steps"],{fallbackNumeric:true});
    if(!colTime||!colSteps) return setStatus("Couldn’t find time & steps columns.", true);

    const byHour = new Array(24).fill(0);
    const dowSum = new Array(7).fill(0), dowN = new Array(7).fill(0);

    for(const r of rows){
      const d=toDate(r[colTime]); const s=toNumber(r[colSteps]);
      if(!d||s===null) continue;
      byHour[d.getHours()] += s;
      const k=(d.getDay()+6)%7; dowSum[k]+=s; dowN[k]+=1;
    }

    // Nightingale: true 24h — place slices at hour centers (theta in degrees)
    const theta = Array.from({length:24},(_,h)=>(h+0.5)*15); // 360/24 = 15°
    Plotly.newPlot("plot5",
      [{type:"barpolar", r:byHour, theta, width:new Array(24).fill(15)}],
      {title:{text:"Nightingale Rose: Value by Hour (24h)",x:0.02},
       margin:{t:50,l:30,r:30,b:40},
       polar:{ angularaxis:{rotation:90, direction:"clockwise", tickmode:"array",
                ticktext:["12a","1a","2a","3a","4a","5a","6a","7a","8a","9a","10a","11a",
                          "12p","1p","2p","3p","4p","5p","6p","7p","8p","9p","10p","11p"],
                tickvals:Array.from({length:24},(_,i)=>i*15) },
               radialaxis:{ticks:"outside"} }}, config);

    // Radar (mean share by weekday Mon..Sun)
    const means = dowSum.map((s,i)=> dowN[i]? s/dowN[i] : 0);
    const total = means.reduce((a,b)=>a+b,0)||1;
    const share = means.map(v=> 100*v/total);
    const labels = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    Plotly.newPlot("plot6",
      [{type:"scatterpolar", r:share.concat([share[0]]), theta:labels.concat([labels[0]]),
        mode:"lines+markers", fill:"toself"}],
      {title:{text:"Radar: Mean Steps Share by Day of Week",x:0.02},
       margin:{t:50,l:30,r:30,b:40},
       polar:{ angularaxis:{tickmode:"array", ticktext:labels, tickvals:labels},
               radialaxis:{ticks:"outside", title:{text:"% of weekly"}} }}, config);

    setStatus("Rendered Nightingale (24h) & weekly radar."); scrollToPlots();
  });
};

/* ============== Tribolium (cobweb with quadratic & Ricker fits) ============== */
document.getElementById("btn-make-trib").onclick = function(){
  flash(this);
  const f=document.getElementById("file-trib").files[0];
  if(!f) return setStatus("Upload a Tribolium CSV first.", true);
  readCSV(f, rows=>{
    const colVal = pickColumn(rows,["adults","count","population","value","n"], {fallbackNumeric:true});
    if(!colVal) return setStatus("Couldn’t find Adults/value column.", true);
    const series = toNumberArray(rows.map(r=>r[colVal]));
    if(series.length<5) return setStatus("Need ≥5 numeric rows.", true);
    const x = series.slice(0,-1), y = series.slice(1);

    // Quadratic fit y = a + b x + c x^2 (normal equations)
    const n=x.length;
    let Sx=0,Sx2=0,Sx3=0,Sx4=0,Sy=0,Sxy=0,Sx2y=0;
    for(let i=0;i<n;i++){ const xi=x[i], yi=y[i], x2=xi*xi; Sx+=xi; Sx2+=x2; Sx3+=x2*xi; Sx4+=x2*x2; Sy+=yi; Sxy+=xi*yi; Sx2y+=x2*yi; }
    function solve3(A,B){ const M=A.map((r,i)=>r.concat([B[i]])), m=M.length;
      for(let k=0;k<m;k++){ let p=k; for(let i=k+1;i<m;i++) if(Math.abs(M[i][k])>Math.abs(M[p][k])) p=i;
        [M[k],M[p]]=[M[p],M[k]]; const piv=M[k][k]||1e-12;
        for(let j=k;j<=m;j++) M[k][j]/=piv;
        for(let i=0;i<m;i++) if(i!==k){ const f=M[i][k]; for(let j=k;j<=m;j++) M[i][j]-=f*M[k][j]; } }
      return M.map(r=>r[m]);
    }
    const [a,b,c] = solve3([[n,Sx,Sx2],[Sx,Sx2,Sx3],[Sx2,Sx3,Sx4]],[Sy,Sxy,Sx2y]);

    // Ricker fit y = x * exp(r (1 - x/K)) via simple LS on log(y/x) ~ r - (r/K) x
    const valid = x.map((xi,i)=> xi>0 && y[i]>0 ? i : -1).filter(i=>i>=0);
    const X = valid.map(i=>x[i]), Y = valid.map(i=>Math.log(y[i]/x[i]));
    function linfit(X,Y){ const n=X.length; let sx=0, sy=0, sxx=0, sxy=0; for(let i=0;i<n;i++){ sx+=X[i]; sy+=Y[i]; sxx+=X[i]*X[i]; sxy+=X[i]*Y[i]; }
      const b=(n*sxy-sx*sy)/(n*sxx-sx*sx); const a=(sy-b*sx)/n; return {a,b}; }
    const lf = linfit(X,Y); const r=lf.a, K = -r/lf.b;

    const xmin=Math.min(...x,...y), xmax=Math.max(...x,...y);
    const xs=Array.from({length:400},(_,i)=> xmin+(xmax-xmin)*i/399);
    const fquad=xs.map(v=> a+b*v+c*v*v);
    const frick=xs.map(v=> v*Math.exp(r*(1-v/K)));

    const traces = [
      {x:x, y:y, mode:"markers", name:"data"},
      {x:xs, y:fquad, mode:"lines", name:`Quadratic`},
      {x:xs, y:frick, mode:"lines", name:`Ricker`}
    ];
    traces.push(addDiag(x,y));

    Plotly.newPlot("plot1", traces,
      {title:{text:"Cobweb (map fit) – Tribolium",x:0.02},
       margin:{t:50,l:70,r:30,b:60},
       xaxis:{title:"x(t)"}, yaxis:{title:"x(t+1)"}}, config);

    setStatus("Rendered Tribolium cobweb with quadratic/Ricker fits."); scrollToPlots();
  });
};

/* ============== Mites predator–prey (phase with smoothing + returns) ============== */
document.getElementById("btn-make-mites").onclick = function(){
  flash(this);
  const f=document.getElementById("file-mites").files[0];
  if(!f) return setStatus("Upload a Mites predator–prey CSV first.", true);
  const optSmooth = document.getElementById("opt-smooth").checked;
  const optLV     = document.getElementById("opt-lv").checked;
  const optLog    = document.getElementById("opt-log").checked;
  const optTime   = document.getElementById("opt-timepts").checked;

  readCSV(f, rows=>{
    const colT = pickColumn(rows,["time","t","step","index","day","week"],{fallbackNumeric:true});
    const colPrey = pickColumn(rows,["prey","preys","preycount","victim"],{fallbackNumeric:true});
    const colPred = pickColumn(rows,["predator","predators","lynx","hunter"],{fallbackNumeric:true});
    if(!colT||!colPrey||!colPred) return setStatus("Need time, prey, predator columns.", true);

    let T=rows.map(r=>({t:toNumber(r[colT]), x:toNumber(r[colPrey]), y:toNumber(r[colPred])}))
              .filter(r=>r.t!==null && r.x!==null && r.y!==null)
              .sort((a,b)=>a.t-b.t);
    if (T.length<5) return setStatus("Need ≥5 rows for mites.", true);

    const time=T.map(r=>r.t), prey=T.map(r=>r.x), pred=T.map(r=>r.y);

    // Phase-plane
    const ppTraces=[];
    ppTraces.push({x:prey, y:pred, mode:"lines", name:"path", line:{width:2}});
    ppTraces.push({
      x:prey, y:pred, mode:"markers", name:"time",
      marker: optTime ? {size:6, color:time.map((_,i)=>i), colorscale:"Blues", showscale:true, colorbar:{title:"order", x:1.12}}
                      : {size:6}
    });
    if (optSmooth){
      const sm=interp1(prey,pred,20);
      ppTraces.push({x:sm.xs, y:sm.ys, mode:"lines", name:"smoothed", line:{dash:"dot"}});
    }
    if (optLV){
      // crude LV fit via least squares on dx/dt and dy/dt (finite diff)
      const dt=[], dx=[], dy=[], xmid=[], ymid=[];
      for(let i=0;i<time.length-1;i++){
        const h=time[i+1]-time[i]; if(!h) continue;
        dt.push(h); dx.push((prey[i+1]-prey[i])/h); dy.push((pred[i+1]-pred[i])/h);
        xmid.push(0.5*(prey[i+1]+prey[i])); ymid.push(0.5*(pred[i+1]+pred[i]));
      }
      // dx/dt = a x - b x y ; dy/dt = -c y + d x y
      function fitAB(x,y,z){ // z ≈ a*x + b*(x*y) with b expected negative
        const X1=x, X2=x.map((v,i)=>v*y[i]); const n=x.length;
        let s11=0,s12=0,s22=0, s1z=0,s2z=0;
        for(let i=0;i<n;i++){ s11+=X1[i]*X1[i]; s12+=X1[i]*X2[i]; s22+=X2[i]*X2[i]; s1z+=X1[i]*z[i]; s2z+=X2[i]*z[i]; }
        const det=s11*s22-s12*s12 || 1e-12;
        const a=( s22*s1z - s12*s2z)/det, b=(-s12*s1z + s11*s2z)/det;
        return {a,b};
      }
      const ab = fitAB(xmid, ymid, dx);
      const cd = fitAB(ymid, xmid, dy); // note order to match −c*y + d*x*y
      const a=ab.a, b=-ab.b, c=-cd.a, d=cd.b;
      // integrate model from first point to draw a smooth orbit
      const xs=[prey[0]], ys=[pred[0]];
      const steps=800, h=(time.at(-1)-time[0])/(steps-1)||1;
      for(let i=1;i<steps;i++){
        const x0=xs[i-1], y0=ys[i-1];
        const k1x = a*x0 - b*x0*y0, k1y = -c*y0 + d*x0*y0;
        const x1 = x0 + h*k1x,     y1 = y0 + h*k1y;
        xs.push(x1); ys.push(y1);
      }
      ppTraces.push({x:xs, y:ys, mode:"lines", name:"LV orbit (fit)", line:{width:2, dash:"dash"}});
    }

    Plotly.newPlot("plot2", ppTraces,
      {title:{text:"Phase Plane: Prey vs Predator",x:0.02},
       margin:{t:50,l:70,r:80,b:60},
       xaxis:{title:"Prey(t)", type: optLog? "log": undefined},
       yaxis:{title:"Predator(t)", type: optLog? "log": undefined},
       legend:{orientation:"h"}}, config);

    // Returns (Prey, Predator)
    const xt=prey.slice(0,-1), xt1=prey.slice(1);
    const yt=pred.slice(0,-1), yt1=pred.slice(1);
    Plotly.newPlot("plot3",
      [{x:xt,y:xt1,mode:"markers",name:"Return"}, addDiag(xt,xt1)],
      {title:{text:"Return: Prey(t) → Prey(t+1)",x:0.02}, margin:{t:50,l:70,r:20,b:60},
       xaxis:{title:"Prey(t)"}, yaxis:{title:"Prey(t+1)"}}, config);
    Plotly.newPlot("plot4",
      [{x:yt,y:yt1,mode:"markers",name:"Return"}, addDiag(yt,yt1)],
      {title:{text:"Return: Predator(t) → Predator(t+1)",x:0.02}, margin:{t:50,l:70,r:20,b:60},
       xaxis:{title:"Predator(t)"}, yaxis:{title:"Predator(t+1)"}}, config);

    setStatus("Rendered mites phase-plane (smoothed) & returns."); scrollToPlots();
  });
};

/* Clears */
document.getElementById("btn-clear").onclick = function(){ flash(this); for(let i=1;i<=6;i++) Plotly.purge("plot"+i); setStatus("Cleared plots."); };
document.getElementById("btn-clear-files").onclick = function(){ flash(this); ["file-hl","file-fitbit","file-trib","file-mites"].forEach(id=>{const el=document.getElementById(id); if(el) el.value="";}); setStatus("Cleared chosen files. (Nothing uploads)"); };

</script>
</body>
</html>


