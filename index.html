<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coupled Oscillators — Interactive Charts</title>

<!-- Libraries -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root { --pad: 14px; }
* { box-sizing: border-box; }
body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0c10; color:#e8e8e8; }
header { position:sticky; top:0; z-index:10; background:#111217; border-bottom:1px solid #20232f; padding:var(--pad); }
h1 { margin:0 0 4px; font-size:20px; }
.muted { color:#9aa3b2; font-size:12px; }

.shell { display:grid; grid-template-columns: 340px 1fr; gap:16px; height:calc(100dvh - 68px); padding:var(--pad); }
@media (max-width: 900px){ .shell { grid-template-columns: 1fr; grid-auto-rows: min-content 1fr; height:auto; } }

.card { background:#14161d; border:1px solid #1f2330; border-radius:12px; box-shadow:0 0 0 1px #0b0c10 inset; }
.controls { padding:var(--pad); }
.plots { display:flex; flex-direction:column; min-height:0; }
.toolbar { display:flex; align-items:center; gap:10px; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #1f2330; }
.viewbar { display:flex; gap:8px; align-items:center; }
button { cursor:pointer; padding:8px 10px; border-radius:8px; border:1px solid #2b3245; background:#0f1117; color:#e8e8e8; transition:.15s; }
button:hover { background:#151a24; }
button.active { background:#1d2433; border-color:#3a4a6a; box-shadow:0 0 0 2px rgba(110,168,254,.32); }
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
label { display:block; font-size:12px; color:#cfd3dc; margin:8px 0 6px; }
textarea, input[type=file] { width:100%; background:#0f1117; color:#e8e8e8; border:1px solid #2b3245; border-radius:8px; padding:8px; }
textarea { min-height:84px; resize:vertical; }

.scrollplots { overflow:auto; padding:12px; gap:16px; display:grid; grid-template-columns: 1fr 1fr; }
.scrollplots.cols1 { grid-template-columns: 1fr; }
.scrollplots.cols3 { grid-template-columns: 1fr 1fr 1fr; }
.plot { min-height:520px; width:100%; background:#0f1117; border:1px solid #1f2330; border-radius:10px; padding:8px; }
.cols1 .plot { min-height:640px; }

/* Plot text/layout fixes */
.js-plotly-plot .gtitle { white-space:normal !important; }
.js-plotly-plot .main-svg { overflow:visible !important; }
.status { margin:6px 12px; font-size:12px; color:#e3e7ef; }
.tip { color:#9aa3b2; font-size:12px; }
</style>
</head>
<body>
<header>
  <h1>Coupled Oscillators — Interactive Charts</h1>
  <div class="muted">Header & controls stay fixed. Graphs have their own scroll area. Double-click a plot to fullscreen.</div>
</header>

<div class="shell">
  <!-- Controls -->
  <div class="card controls">
    <h3 style="margin:4px 0 10px">Startup Box — Quick X/Y</h3>
    <label>X values (comma/space/newline-separated)</label>
    <textarea id="xvals" placeholder="e.g., 1, 2, 3, 4"></textarea>
    <label>Y values (same length as X)</label>
    <textarea id="yvals" placeholder="e.g., 2, 4, 3, 6"></textarea>
    <div class="grid-2" style="margin-top:8px">
      <button id="btn-scatter">Make Scatter</button>
      <button id="btn-line">Make Connected Line</button>
    </div>

    <hr style="border:none; border-top:1px solid #1f2330; margin:14px 0">
    <h3 style="margin:4px 0 10px">Upload CSVs</h3>

    <label>Hare–Lynx CSV (flexible headers Year/Hare/Lynx)</label>
    <input type="file" id="file-hl" accept=".csv" />
    <label>Fitbit minute CSV (flexible timestamp/time + steps/value)</label>
    <input type="file" id="file-fitbit" accept=".csv" />
    <label>Tribolium CSV (flexible t/index/time + Adults/population/value)</label>
    <input type="file" id="file-trib" accept=".csv" />

    <div class="grid-2" style="margin-top:10px">
      <button id="btn-make-lynx">Phase & Return (HL)</button>
      <button id="btn-make-fitbit">Rose & Radar</button>
    </div>
    <div class="grid-2" style="margin-top:8px">
      <button id="btn-make-trib">Cobweb (Tribolium)</button>
      <button id="btn-clear">Clear Plots</button>
    </div>
    <div class="grid-2" style="margin-top:8px">
      <button id="btn-clear-files">Clear Files</button>
      <div class="muted" style="align-self:center">Files never leave your device.</div>
    </div>
    <p class="muted" style="margin-top:8px">Use the camera icon on any chart to download a PNG.</p>
  </div>

  <!-- Plots -->
  <div class="card plots">
    <div class="toolbar">
      <div class="viewbar">
        <span class="muted">View:</span>
        <button id="view-1">1-up</button>
        <button id="view-2" class="active">2-up</button>
        <button id="view-3">3-up</button>
      </div>
      <div class="tip">Use the camera icon on any chart to download a PNG.</div>
    </div>
    <div id="status" class="status">Ready.</div>
    <div id="grid" class="scrollplots">
      <div id="plot1" class="plot"></div>
      <div id="plot2" class="plot"></div>
      <div id="plot3" class="plot"></div>
      <div id="plot4" class="plot"></div>
      <div id="plot5" class="plot"></div>
      <div id="plot6" class="plot"></div>
    </div>
  </div>
</div>

<script>
/* ============== helpers ============== */
const config = { responsive: true, displaylogo: false };

function setStatus(msg, isError=false){
  const el = document.getElementById('status');
  el.textContent = msg;
  el.style.color = isError ? '#ffb4b4' : '#e3e7ef';
}

function toNumber(v){
  if (v === null || v === undefined) return null;
  if (typeof v === 'number' && Number.isFinite(v)) return v;
  let s = String(v).trim(); if (!s) return null;
  s = s.replace(/(?<=\\d)[\\s,](?=\\d)/g,'');
  const pct = /%$/.test(s); s = s.replace(/%$/,'');
  const n = Number(s); if (!Number.isFinite(n)) return null;
  return pct ? n/100 : n;
}
const toNumberArray = arr => arr.map(toNumber).filter(v => v !== null);

function toDate(v){
  if (v===null || v===undefined || v==='') return null;
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v === 'number'){ const ms = v >= 1e12 ? v : (v >= 1e9 ? v*1000 : v); const d = new Date(ms); return isNaN(d)?null:d; }
  const s = String(v).trim(); let d = new Date(s); if (!isNaN(d)) return d;
  d = new Date(s.replace(/-/g,'/')); return isNaN(d)?null:d;
}

function normKey(k){ return String(k||'').toLowerCase().replace(/[^a-z0-9]+/g,''); }
function pickColumn(rows, opts, {fallbackNumeric=false} = {}){
  if (!rows?.length) return null;
  const map = {}; Object.keys(rows[0]).forEach(k => map[normKey(k)] = k);
  for (const o of opts){ const nk = normKey(o); if (nk in map) return map[nk]; }
  if (fallbackNumeric){
    for (const c of Object.keys(rows[0])){
      const vals = rows.slice(0, Math.min(30, rows.length)).map(r => toNumber(r[c]));
      if (vals.filter(v => v !== null).length >= Math.ceil(vals.length*0.6)) return c;
    }
  }
  return null;
}

function readCSV(file, cb){
  Papa.parse(file, {
    header:true, skipEmptyLines:true, dynamicTyping:false,
    complete: res => { setStatus(`Loaded ${file.name} (${res.data.length} rows)`); cb(res.data); },
    error: err => setStatus('CSV parse error: '+err, true)
  });
}

function baseLayout(title, extra={}){
  return Object.assign({
    title:{ text:title, x:0.02, xanchor:'left', font:{size:16} },
    margin:{ t:60, r:30, b:60, l:70 },
    xaxis:{ title:{text:''}, automargin:true, tickfont:{size:11}, titlefont:{size:12} },
    yaxis:{ title:{text:''}, automargin:true, tickfont:{size:11}, titlefont:{size:12} },
    hoverlabel:{ font:{size:11} }
  }, extra);
}
function polarLayout(title, extra={}){
  return Object.assign({
    title:{ text:title, x:0.02, xanchor:'left', font:{size:16} },
    margin:{ t:60, r:30, b:40, l:30 },
    polar:{
      angularaxis:{ tickfont:{size:11}, direction:'clockwise' },
      radialaxis:{ tickfont:{size:11}, angle:0, ticks:'outside' }
    },
    hoverlabel:{ font:{size:11} }
  }, extra);
}

function smoothXY(x, y, win = 9){
  // simple moving average on sorted x
  const idx = x.map((v,i)=>[v,i]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
  const xs = idx.map(i=>x[i]), ys = idx.map(i=>y[i]);
  const half = Math.max(1, Math.floor(win/2));
  const slx=[], sly=[];
  for (let i=0;i<xs.length;i++){
    const a = Math.max(0, i-half), b = Math.min(xs.length-1, i+half);
    const sx = xs.slice(a,b+1), sy = ys.slice(a,b+1);
    const mx = sx.reduce((s,v)=>s+v,0)/sx.length;
    const my = sy.reduce((s,v)=>s+v,0)/sy.length;
    slx.push(mx); sly.push(my);
  }
  return {x: slx, y: sly};
}

function clearPlots(){ for (let i=1;i<=6;i++) Plotly.purge('plot'+i); setStatus('Cleared.'); }
function clearFiles(){ ['file-hl','file-fitbit','file-trib'].forEach(id => { const el=document.getElementById(id); if (el) el.value=''; }); setStatus('Cleared chosen files.'); }

/* ============== Quick X/Y ============== */
function parseSeries(t){ if (!t) return []; return toNumberArray(t.replace(/[;,\\t\\r\\n]+/g,' ').trim().split(/\\s+/)); }
document.getElementById('btn-scatter').onclick = () => {
  const xs = parseSeries(document.getElementById('xvals').value);
  const ys = parseSeries(document.getElementById('yvals').value);
  if (xs.length !== ys.length || xs.length < 2) return setStatus('X and Y must be same length (≥2).', true);
  Plotly.newPlot('plot1', [{x:xs, y:ys, mode:'markers', type:'scatter'}],
    baseLayout('Custom Scatter (X vs Y)', {xaxis:{title:{text:'X'}}, yaxis:{title:{text:'Y'}}}), config);
  setStatus('Rendered custom scatter.');
};
document.getElementById('btn-line').onclick = () => {
  const xs = parseSeries(document.getElementById('xvals').value);
  const ys = parseSeries(document.getElementById('yvals').value);
  if (xs.length !== ys.length || xs.length < 2) return setStatus('X and Y must be same length (≥2).', true);
  Plotly.newPlot('plot1', [{x:xs, y:ys, mode:'lines+markers', type:'scatter'}],
    baseLayout('Custom Connected Line (X vs Y)', {xaxis:{title:{text:'X'}}, yaxis:{title:{text:'Y'}}}), config);
  setStatus('Rendered connected line.');
};

/* ============== Hare–Lynx ============== */
document.getElementById('btn-make-lynx').onclick = () => {
  const f = document.getElementById('file-hl').files[0];
  if (!f) return setStatus('Upload a Hare–Lynx CSV first.', true);
  readCSV(f, rows => {
    const cY = pickColumn(rows, ['Year','year','date','yr'], {fallbackNumeric:true});
    const cH = pickColumn(rows, ['Hare','hares','prey','harecount'], {fallbackNumeric:true});
    const cL = pickColumn(rows, ['Lynx','predator','lynxcount'], {fallbackNumeric:true});
    if (!cY||!cH||!cL) return setStatus('Couldn’t find Year/Hare/Lynx columns.', true);

    let T = rows.map(r=>({y:toNumber(r[cY]), h:toNumber(r[cH]), l:toNumber(r[cL])}))
                .filter(r=>r.y!==null && r.h!==null && r.l!==null)
                .sort((a,b)=>a.y-b.y);
    if (T.length < 3) return setStatus('Need ≥ 3 numeric rows.', true);

    const year = T.map(r=>r.y), hare = T.map(r=>r.h), lynx = T.map(r=>r.l);
    const order = year.map((_,i)=>i);

    // Phase plane with order colorbar
    Plotly.newPlot('plot2',
      [
        { x:hare, y:lynx, mode:'lines', name:'path', line:{width:1.8} },
        { x:hare, y:lynx, mode:'markers', name:'time', marker:{ size:6, color:order, colorscale:'Blues',
          colorbar:{ title:'order' } } }
      ],
      baseLayout('Phase Plane: Hare vs Lynx', {
        xaxis:{ title:{text:'Hare(t)'}, tickformat:',~s' },
        yaxis:{ title:{text:'Lynx(t)'}, tickformat:',~s' }
      }), config
    );

    // Return maps + smooth + y=x reference
    const ht=hare.slice(0,-1), ht1=hare.slice(1);
    const lt=lynx.slice(0,-1), lt1=lynx.slice(1);
    const diag = (x,y)=>({x:[Math.min(...x,...y),Math.max(...x,...y)], y:[Math.min(...x,...y),Math.max(...x,...y)],
                          mode:'lines', line:{dash:'dot'}, hoverinfo:'skip', showlegend:false});
    const sH = smoothXY(ht, ht1, 11);
    const sL = smoothXY(lt, lt1, 11);

    Plotly.newPlot('plot3',
      [
        {x:ht, y:ht1, mode:'markers', name:'Hare', type:'scatter'},
        {x:sH.x, y:sH.y, mode:'lines', name:'smooth', line:{width:2, color:'#ffa652'}},
        diag(ht, ht1)
      ],
      baseLayout('Return: Hare(t) → Hare(t+1)', {
        xaxis:{ title:{text:'Hare(t)'}, tickformat:',~s' },
        yaxis:{ title:{text:'Hare(t+1)'}, tickformat:',~s' }
      }), config
    );

    Plotly.newPlot('plot4',
      [
        {x:lt, y:lt1, mode:'markers', name:'Lynx', type:'scatter'},
        {x:sL.x, y:sL.y, mode:'lines', name:'smooth', line:{width:2, color:'#ffa652'}},
        diag(lt, lt1)
      ],
      baseLayout('Return: Lynx(t) → Lynx(t+1)', {
        xaxis:{ title:{text:'Lynx(t)'}, tickformat:',~s' },
        yaxis:{ title:{text:'Lynx(t+1)'}, tickformat:',~s' }
      }), config
    );

    setStatus('Rendered Hare–Lynx phase and return maps.');
  });
};

/* ============== Fitbit (hour rose + weekday share radar) ============== */
document.getElementById('btn-make-fitbit').onclick = () => {
  const f = document.getElementById('file-fitbit').files[0];
  if (!f) return setStatus('Upload a Fitbit/time CSV first.', true);

  readCSV(f, rows => {
    const cT = pickColumn(rows, ['timestamp','time','datetime','date','ActivityMinute']);
    const cS = pickColumn(rows, ['steps','value','count','activity','stepcount','Steps'], {fallbackNumeric:true});
    if (!cT||!cS) return setStatus('Couldn’t find time & steps columns.', true);

    // Totals
    const byHour = new Array(24).fill(0);
    const dowSum = new Array(7).fill(0), dowCnt = new Array(7).fill(0);

    for (const r of rows){
      const d = toDate(r[cT]); const v = toNumber(r[cS]);
      if (!d || v===null) continue;
      byHour[d.getHours()] += v;
      const k = (d.getDay()+6)%7; // Mon=0
      dowSum[k] += v; dowCnt[k] += 1;
    }
    if (byHour.every(v=>v===0)) return setStatus('No usable Fitbit rows.', true);

    // Nightingale rose — 24 bins, hour labels (no degree labels)
    const thetaDeg = [...Array(24).keys()].map(h => h*15 + 7.5); // center of each hour bin
    const hourTicks = [...Array(24).keys()].map(h=>h*15);
    const hourLabels = [...Array(24).keys()].map(h=>`${h}`);

    Plotly.newPlot('plot5',
      [{ type:'barpolar', r:byHour, theta:thetaDeg, width:new Array(24).fill(360/24), name:'value' }],
      polarLayout('Nightingale Rose: Value by Hour', {
        polar:{ angularaxis:{
                  tickmode:'array', tickvals: hourTicks, ticktext: hourLabels, rotation:90, direction:'clockwise'
                }},
      }), config
    );

    // Radar — mean share by weekday (percent of daily total)
    // Compute share: for each day, sum steps; then distribute steps of that day across that weekday's bucket
    // Approximated from available row granularity: use mean steps per row per weekday, then convert to share
    const weekdayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    // Percent share of total across week by weekday
    const total = dowSum.reduce((s,v)=>s+v,0) || 1;
    const share = dowSum.map(v => 100 * v / total);

    Plotly.newPlot('plot6',
      [{ type:'scatterpolar', r:[...share, share[0]], theta:[...weekdayNames, weekdayNames[0]],
         mode:'lines+markers', fill:'toself', name:'mean %' }],
      polarLayout('Radar: Mean Steps Share by Day of Week'), config
    );

    setStatus('Rendered Fitbit hour rose (0–23h) and weekday share radar.');
  });
};

/* ============== Tribolium (cobweb with Quadratic & Ricker map fits) ============== */
document.getElementById('btn-make-trib').onclick = () => {
  const f = document.getElementById('file-trib').files[0];
  if (!f) return setStatus('Upload a Tribolium CSV first.', true);

  readCSV(f, rows => {
    const cT = pickColumn(rows, ['t','time','step','index'], {fallbackNumeric:true});
    const cV = pickColumn(rows, ['adults','population','value','count','n'], {fallbackNumeric:true});
    if (!cT || !cV) return setStatus('Couldn’t find t & Adults columns.', true);

    const seq = toNumberArray(rows.map(r=>r[cV]));
    if (seq.length < 3) return setStatus('Need ≥ 3 numeric rows.', true);
    const x = seq.slice(0,-1), y = seq.slice(1);

    // Fit Quadratic: y = a + b x + c x^2
    const n=x.length;
    let Sx=0,Sx2=0,Sx3=0,Sx4=0,Sy=0,Sxy=0,Sx2y=0;
    for (let i=0;i<n;i++){ const xi=x[i], yi=y[i], x2=xi*xi; Sx+=xi; Sx2+=x2; Sx3+=x2*xi; Sx4+=x2*x2; Sy+=yi; Sxy+=xi*yi; Sx2y+=x2*yi; }
    function solve3(A,B){ const M=A.map((r,i)=>r.concat([B[i]])); const m=M.length;
      for(let k=0;k<m;k++){ let p=k; for(let i=k+1;i<m;i++) if(Math.abs(M[i][k])>Math.abs(M[p][k])) p=i;
        [M[k],M[p]]=[M[p],M[k]]; const pv=M[k][k]||1e-12;
        for(let j=k;j<=m;j++) M[k][j]/=pv;
        for(let i=0;i<m;i++) if(i!==k){ const f=M[i][k]; for(let j=k;j<=m;j++) M[i][j]-=f*M[k][j]; } }
      return M.map(r=>r[m]);
    }
    const [a,b,c] = solve3([[n,Sx,Sx2],[Sx,Sx2,Sx3],[Sx2,Sx3,Sx4]],[Sy,Sxy,Sx2y]);

    // Fit Ricker-like y = x * exp(r * (1 - x/K))
    // Fast grid search for r,K (good enough for visualization)
    function rickerErr(r,K){
      let e=0; for (let i=0;i<n;i++){ const yi = x[i]*Math.exp(r*(1 - x[i]/K)); const d=yi-y[i]; e+=d*d; }
      return e/n;
    }
    let best={r:0.5,K:1,err:Infinity};
    const xmin=Math.min(...x), xmax=Math.max(...x);
    const K0 = xmax*1.2;
    for (let r=-1; r<=2; r+=0.05){
      for (let k=K0*0.25; k<=K0*3; k+= (K0*0.05)){
        const e = rickerErr(r,k);
        if (e < best.err) best={r:r,K:k,err:e};
      }
    }

    const xs = Array.from({length:400},(_,i)=> xmin + (xmax-xmin)*i/399);
    const fQ = xs.map(v=> a + b*v + c*v*v);
    const fR = xs.map(v=> v*Math.exp(best.r*(1 - v/best.K)));

    Plotly.newPlot('plot1',
      [
        {x:x, y:y, mode:'markers', name:'data', marker:{size:5}},
        {x:xs, y:fQ, mode:'lines', name:`Quadratic (R²≈${rsq(x,y, v=>a+b*v+c*v*v).toFixed(3)})`},
        {x:xs, y:fR, mode:'lines', name:`Ricker  (R²≈${rsq(x,y, v=>v*Math.exp(best.r*(1-v/best.K))).toFixed(3)})`, line:{dash:'dash'}}
      ],
      baseLayout('Cobweb (map fit) – Tribolium', {
        xaxis:{title:{text:'x(t)'}}, yaxis:{title:{text:'x(t+1)'}},
        shapes:[ // axes crosshair like your example
          {type:'line', x0:xmin, x1:xmax, y0:0, y1:0, line:{color:'#666'}},
          {type:'line', x0:0, x1:0, y0:Math.min(...y), y1:Math.max(...y), line:{color:'#666'}}
        ]
      }), config
    );

    setStatus('Rendered Tribolium map fits (Quadratic & Ricker).');

    function rsq(x,y,f){ // coefficient of determination vs fitted function f(x)
      const yhat = x.map(f);
      const ybar = y.reduce((s,v)=>s+v,0)/y.length;
      let ssr=0,sst=0;
      for (let i=0;i<y.length;i++){ ssr += Math.pow(y[i]-yhat[i],2); sst += Math.pow(y[i]-ybar,2); }
      return Math.max(0, 1 - (ssr/(sst||1)));
    }
  });
};

/* ============== View mode + Fullscreen ============== */
const grid = document.getElementById('grid');
document.getElementById('view-1').onclick = (e)=>{ grid.classList.add('cols1'); grid.classList.remove('cols3'); setActive(e.target); };
document.getElementById('view-2').onclick = (e)=>{ grid.classList.remove('cols1','cols3'); setActive(e.target); };
document.getElementById('view-3').onclick = (e)=>{ grid.classList.add('cols3'); grid.classList.remove('cols1'); setActive(e.target); };
function setActive(btn){
  document.querySelectorAll('.viewbar button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

// Fullscreen on double-click
for (let i=1;i<=6;i++){
  const id = 'plot'+i;
  document.getElementById(id).addEventListener('dblclick', ()=>openFS(id));
}
let fs=null;
function openFS(id){
  if (fs) return;
  const src = document.getElementById(id);
  const wrap = document.createElement('div');
  wrap.style.cssText='position:fixed;inset:0;background:rgba(11,12,16,.98);z-index:9999;display:grid;place-items:center;padding:12px';
  wrap.innerHTML = '<div id="fsplot" style="width:min(1200px,95vw);height:min(92vh,900px)"></div><button id="xfs" style="position:fixed;top:10px;right:12px" class="active">Close (Esc)</button>';
  document.body.appendChild(wrap); fs=wrap;
  const d = src.data ? JSON.parse(JSON.stringify(src.data)) : [];
  const L = src.layout ? JSON.parse(JSON.stringify(src.layout)) : {};
  Plotly.newPlot('fsplot', d, L, {responsive:true, displaylogo:false});
  document.getElementById('xfs').onclick = closeFS; document.addEventListener('keydown', escFS);
}
function escFS(e){ if (e.key==='Escape') closeFS(); }
function closeFS(){ if (!fs) return; document.removeEventListener('keydown', escFS); fs.remove(); fs=null; }

/* ============== clears ============== */
document.getElementById('btn-clear').onclick = clearPlots;
document.getElementById('btn-clear-files').onclick = clearFiles;
</script>
</body>
</html>



