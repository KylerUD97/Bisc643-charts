<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Coupled Oscillators — Interactive Charts</title>

<!-- Libraries -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root { --pad:14px; }
  body{margin:0;background:#0b0c10;color:#e8e8e8;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;background:#111217;border-bottom:1px solid #222;padding:var(--pad)}
  h1{margin:0 0 6px;font-size:20px}
  .muted{color:#9aa3b2;font-size:12px}

  /* Layout: fixed header + two columns; plots have their own scroll area */
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;height:calc(100vh - 68px);padding:var(--pad)}
  .controls{overflow:auto}
  .plots{display:flex;flex-direction:column;min-width:0}
  .plot-scroll{overflow:auto;border:1px solid #1f2330;border-radius:12px;background:#0f1117;padding:12px}

  @media (max-width: 900px){
    .wrap{grid-template-columns:1fr;grid-template-rows:auto 1fr}
  }

  .card{background:#14161d;border:1px solid #1f2330;border-radius:12px;padding:var(--pad);box-shadow:0 0 0 1px #0b0c10 inset}
  .card h2{font-size:16px;margin:0 0 8px}
  label{display:block;font-size:12px;margin-bottom:6px;color:#cfd3dc}
  textarea,input,button{width:100%;box-sizing:border-box;font:inherit;padding:8px;border-radius:8px;border:1px solid #2b3245;background:#0f1117;color:#e8e8e8}
  textarea{min-height:80px;resize:vertical}
  button{cursor:pointer;transition:background .15s,border-color .15s,box-shadow .15s}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}

  /* view buttons + active */
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0 10px}
  .viewbar{display:inline-flex;gap:8px;align-items:center}
  button.active{background:#1d2433;border-color:#3a4a6a;box-shadow:0 0 0 2px rgba(110,168,254,.35)}
  .viewbar button{width:auto;padding-inline:10px}

  /* plots grid */
  .row{display:grid;gap:16px;grid-template-columns:1fr 1fr}
  .row.cols1{grid-template-columns:1fr}
  .row.cols2{grid-template-columns:1fr 1fr}
  .row.cols3{grid-template-columns:1fr 1fr 1fr}
  .plot{min-height:520px;width:100%;background:#0b0c10;border:1px solid #1f2330;border-radius:8px}

  /* help Plotly layout */
  .js-plotly-plot .gtitle{white-space:normal!important}
  .js-plotly-plot .main-svg{overflow:visible!important}
</style>
</head>
<body>
<header>
  <h1>Coupled Oscillators — Interactive Charts</h1>
  <div class="muted">Header & controls stay fixed. Graphs have their own scroll area. Double-click a plot to fullscreen. </div>
</header>

<div class="wrap">
  <!-- Controls -->
  <div class="card controls">
    <h2>Startup Box — Quick X/Y</h2>
    <label>X values (comma/space/newline-separated)</label>
    <textarea id="xvals" placeholder="e.g., 1, 2, 3, 4"></textarea>
    <label>Y values (same length as X)</label>
    <textarea id="yvals" placeholder="e.g., 2, 4, 3, 6"></textarea>
    <div class="grid-2">
      <button id="btn-scatter">Make Scatter</button>
      <button id="btn-line">Make Connected Line</button>
    </div>

    <hr style="border-color:#1f2330;margin:14px 0">

    <h2>Upload CSVs</h2>

    <label>Hare–Lynx CSV (flexible headers: Year/Hare/Lynx)</label>
    <input type="file" id="file-hl" accept=".csv"/>

    <label>Fitbit by-minute CSV (flexible: timestamp/time + steps/value)</label>
    <input type="file" id="file-fitbit" accept=".csv"/>

    <label>Tribolium CSV (flexible: t/index/time + Adults/population/value)</label>
    <input type="file" id="file-trib" accept=".csv"/>

    <label>Mites time-series CSV (time + prey + predator; one “universe”)</label>
    <input type="file" id="file-mites" accept=".csv"/>

    <div class="grid-2" style="margin-top:8px">
      <button id="btn-make-lynx">Phase & Return (HL)</button>
      <button id="btn-make-fitbit">Rose & Radar</button>
    </div>
    <div class="grid-2" style="margin-top:8px">
      <button id="btn-make-trib">Cobweb (Tribolium)</button>
      <button id="btn-make-mites">Mites: Phase & Return</button>
    </div>
    <div class="grid-2" style="margin-top:8px">
      <button id="btn-clear">Clear Plots</button>
      <button id="btn-clear-files">Clear Files</button>
    </div>
    <p class="muted" style="margin-top:10px">Files never leave your device. Use the camera icon on any plot to download a PNG.</p>
  </div>

  <!-- Plots -->
  <div class="plots">
    <div class="toolbar">
      <div class="viewbar">
        <span class="muted">View:</span>
        <button id="view-1">1-up</button>
        <button id="view-2">2-up</button>
        <button id="view-3">3-up</button>
      </div>
      <div class="muted">Use the camera icon on any chart to download a PNG.</div>
    </div>

    <div id="status" class="muted" style="margin:0 0 8px 2px"></div>

    <div class="plot-scroll">
      <div id="plot-row" class="row cols2">
        <div id="plot1" class="plot"></div>
        <div id="plot2" class="plot"></div>
        <div id="plot3" class="plot"></div>
        <div id="plot4" class="plot"></div>
        <div id="plot5" class="plot"></div>
        <div id="plot6" class="plot"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== helpers ===================== */
const config = { responsive:true, displaylogo:false };

function setStatus(msg, bad=false){
  const el = document.getElementById('status');
  el.style.color = bad ? '#ffb4b4' : '#9aa3b2';
  el.textContent = msg;
}
const flash = (btn,ms=350)=>{ btn.classList.add('active'); setTimeout(()=>btn.classList.remove('active'),ms); };

function toNumber(v){
  if (v===null||v===undefined) return null;
  if (typeof v==='number' && Number.isFinite(v)) return v;
  let s=String(v).trim(); if (!s) return null;
  s = s.replace(/(?<=\d)[\s,](?=\d)/g,''); // kill 1,234 or 1 234
  const pct = /%$/.test(s); s=s.replace(/%$/,'');
  const n=Number(s); if (!Number.isFinite(n)) return null;
  return pct ? n/100 : n;
}
const toNumberArray = arr => arr.map(toNumber).filter(v=>v!==null);

function toDate(v){
  if (v===null||v===undefined||v==='') return null;
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v==='number'){
    const ms = v>=1e12 ? v : (v>=1e9 ? v*1000 : v);
    const d = new Date(ms); return isNaN(d)?null:d;
  }
  const s=String(v).trim();
  let d=new Date(s); if (!isNaN(d)) return d;
  d=new Date(s.replace(/-/g,'/')); return isNaN(d)?null:d;
}

function normKey(k){ return String(k||'').toLowerCase().replace(/[^a-z0-9]+/g,'').trim(); }
function pickColumn(rows, opts, {fallbackNumeric=false}={}){
  if (!rows.length) return null;
  const map={}; Object.keys(rows[0]).forEach(k=> map[normKey(k)]=k);
  for (const o of opts){ const nk=normKey(o); if (nk in map) return map[nk]; }
  if (fallbackNumeric){
    for (const c of Object.keys(rows[0])){
      const vals = rows.slice(0,Math.min(30,rows.length)).map(r=>toNumber(r[c]));
      if (vals.filter(v=>v!==null).length >= Math.ceil(vals.length*0.6)) return c;
    }
  }
  return null;
}

function readCSV(file, cb){
  Papa.parse(file, {
    header:true, skipEmptyLines:true, dynamicTyping:false,
    complete: res => { 
      if (res.errors?.length) setStatus("CSV warnings: "+res.errors[0].message, true);
      else setStatus(`Loaded ${file.name} (${res.data.length} rows).`);
      cb(res.data);
    },
    error: err => setStatus("CSV parse error: "+err, true)
  });
}

function baseLayout(title, extra={}){
  return Object.assign({
    title:{text:title,x:0.02,xanchor:"left",font:{size:16}},
    margin:{t:60,r:40,b:60,l:70},
    xaxis:{title:{text:""},automargin:true,tickfont:{size:11},titlefont:{size:12}},
    yaxis:{title:{text:""},automargin:true,tickfont:{size:11},titlefont:{size:12}},
    hoverlabel:{font:{size:11}}
  }, extra);
}
function polarLayout(title, extra={}){
  return Object.assign({
    title:{text:title,x:0.02,xanchor:"left",font:{size:16}},
    margin:{t:60,r:40,b:40,l:40},
    polar:{
      angularaxis:{
        direction:"clockwise",
        tickfont:{size:11},
        tickmode:"array"
      },
      radialaxis:{tickfont:{size:11},angle:0,ticks:"outside"}
    },
    hoverlabel:{font:{size:11}}
  }, extra);
}

/* small utilities */
function clearPlots(){ for (let i=1;i<=6;i++) Plotly.purge('plot'+i); setStatus("Cleared."); }
function clearFiles(){ ['file-hl','file-fitbit','file-trib','file-mites'].forEach(id=>{const el=document.getElementById(id); if (el) el.value="";}); setStatus("Cleared chosen files."); }

/* view controls */
const rowEl = document.getElementById('plot-row');
const v1=document.getElementById('view-1'), v2=document.getElementById('view-2'), v3=document.getElementById('view-3');
const vBtns=[v1,v2,v3];
function setCols(n){ rowEl.classList.remove('cols1','cols2','cols3'); rowEl.classList.add('cols'+n); }
function setActive(btn){ vBtns.forEach(b=>{b.classList.remove('active');}); btn.classList.add('active'); }
v1.onclick=()=>{setCols(1); setActive(v1);}; v2.onclick=()=>{setCols(2); setActive(v2);}; v3.onclick=()=>{setCols(3); setActive(v3);};
setCols(2); setActive(v2);

/* fullscreen on dblclick */
for (let i=1;i<=6;i++){
  document.getElementById('plot'+i).addEventListener('dblclick', ()=>{
    const src = document.getElementById('plot'+i);
    const wrap=document.createElement('div');
    wrap.style.cssText="position:fixed;inset:0;background:rgba(11,12,16,.98);z-index:9999;display:grid;place-items:center;padding:10px";
    wrap.innerHTML=`<button id="fs-close" style="position:fixed;top:10px;right:12px;background:#14161d;color:#e8e8e8;border:1px solid #2b3245;border-radius:8px;padding:8px 10px;cursor:pointer">Close (Esc)</button><div style="width:min(1200px,95vw);height:min(90vh,900px)"><div id="fs-plot"></div></div>`;
    document.body.appendChild(wrap);
    Plotly.newPlot('fs-plot', JSON.parse(JSON.stringify(src.data||[])), JSON.parse(JSON.stringify(src.layout||{})), {responsive:true,displaylogo:false});
    const close=()=>{document.removeEventListener('keydown',esc); wrap.remove();};
    const esc=(e)=>{ if (e.key==='Escape') close(); };
    document.getElementById('fs-close').onclick=close; document.addEventListener('keydown',esc);
  });
}

/* ================= Quick X/Y ================= */
function parseSeries(text){ if(!text) return []; return toNumberArray(text.replace(/[;,\t\r\n]+/g,' ').trim().split(/\s+/)); }
document.getElementById('btn-scatter').onclick=function(){
  flash(this);
  const xs=parseSeries(document.getElementById('xvals').value);
  const ys=parseSeries(document.getElementById('yvals').value);
  if (xs.length!==ys.length || xs.length<2) return setStatus("X and Y must be same length (≥2).", true);
  Plotly.newPlot('plot1',[{x:xs,y:ys,mode:'markers',type:'scatter'}],baseLayout("Custom Scatter (X vs Y)",{xaxis:{title:{text:'X'}},yaxis:{title:{text:'Y'}}}),config);
  setStatus("Rendered custom scatter.");
};
document.getElementById('btn-line').onclick=function(){
  flash(this);
  const xs=parseSeries(document.getElementById('xvals').value);
  const ys=parseSeries(document.getElementById('yvals').value);
  if (xs.length!==ys.length || xs.length<2) return setStatus("X and Y must be same length (≥2).", true);
  Plotly.newPlot('plot1',[{x:xs,y:ys,mode:'lines+markers',type:'scatter'}],baseLayout("Custom Connected Line (X vs Y)",{xaxis:{title:{text:'X'}},yaxis:{title:{text:'Y'}}}),config);
  setStatus("Rendered custom line.");
};

/* ================= Hare–Lynx (phase + return) ================= */
document.getElementById('btn-make-lynx').onclick=function(){
  flash(this);
  const f=document.getElementById('file-hl').files[0];
  if(!f) return setStatus("Upload a hare–lynx CSV first.", true);

  readCSV(f, rows=>{
    const colYear=pickColumn(rows,["Year","year","date","yr"],{fallbackNumeric:true});
    const colH=pickColumn(rows,["Hare","hares","prey","harecount"],{fallbackNumeric:true});
    const colL=pickColumn(rows,["Lynx","lynx","predator","lynxcount"],{fallbackNumeric:true});
    if(!colYear||!colH||!colL) return setStatus("Couldn’t find Year/Hare/Lynx.", true);

    let T=rows.map(r=>({t:toNumber(r[colYear]), h:toNumber(r[colH]), l:toNumber(r[colL])}))
              .filter(o=>o.t!==null&&o.h!==null&&o.l!==null)
              .sort((a,b)=>a.t-b.t);
    if (T.length<6) return setStatus("Too few rows (need ≥6).", true);

    const year=T.map(x=>x.t), hare=T.map(x=>x.h), lynx=T.map(x=>x.l);
    const idx=year.map((_,i)=>i);

    const line = {x:hare,y:lynx,mode:'lines',type:'scatter',line:{width:1.8},name:'path'};
    const pts  = {x:hare,y:lynx,mode:'markers',type:'scatter',
                  marker:{size:6,color:idx,colorscale:'Blues',colorbar:{title:'order',x:1.1,thickness:12}},
                  name:'time'};

    Plotly.newPlot('plot2',[line,pts], baseLayout("Phase Plane: Hare vs Lynx",{
      xaxis:{title:{text:"Hare(t)"},tickformat:",~s"},
      yaxis:{title:{text:"Lynx(t)"},tickformat:",~s"}
    }), config);

    // return maps with 1:1 + LS fit
    function lsFit(x,y){ // simple least squares
      const n=x.length; let sx=0,sy=0,sxy=0,sx2=0; 
      for(let i=0;i<n;i++){sx+=x[i]; sy+=y[i]; sxy+=x[i]*y[i]; sx2+=x[i]*x[i];}
      const b=(n*sxy-sx*sy)/(n*sx2-sx*sx); const a=(sy-b*sx)/n; return {a,b};
    }
    const ht=hare.slice(0,-1), ht1=hare.slice(1);
    const lt=lynx.slice(0,-1), lt1=lynx.slice(1);
    const d1={x:[Math.min(...ht,...ht1), Math.max(...ht,...ht1)]}; d1.y=d1.x;
    const d2={x:[Math.min(...lt,...lt1), Math.max(...lt,...lt1)]}; d2.y=d2.x;
    const fH=lsFit(ht,ht1), fL=lsFit(lt,lt1);

    Plotly.newPlot('plot3',[
      {x:ht,y:ht1,mode:'markers',name:'Hare'},
      {x:d1.x,y:d1.y,mode:'lines',line:{dash:'dot'},hoverinfo:'skip',showlegend:false,name:'1:1'},
      {x:d1.x,y:d1.x.map(x=>fH.a+fH.b*x),mode:'lines',name:'LS fit'}
    ], baseLayout("Return: Hare(t) → Hare(t+1)",{
      xaxis:{title:{text:"Hare(t)"},tickformat:",~s"},
      yaxis:{title:{text:"Hare(t+1)"},tickformat:",~s"}
    }), config);

    Plotly.newPlot('plot4',[
      {x:lt,y:lt1,mode:'markers',name:'Lynx'},
      {x:d2.x,y:d2.y,mode:'lines',line:{dash:'dot'},hoverinfo:'skip',showlegend:false,name:'1:1'},
      {x:d2.x,y:d2.x.map(x=>fL.a+fL.b*x),mode:'lines',name:'LS fit'}
    ], baseLayout("Return: Lynx(t) → Lynx(t+1)",{
      xaxis:{title:{text:"Lynx(t)"},tickformat:",~s"},
      yaxis:{title:{text:"Lynx(t+1)"},tickformat:",~s"}
    }), config);

    setStatus("Rendered HL phase plane & return maps.");
  });
};

/* ================= Fitbit (true 24-hour rose + weekday radar) ================= */
document.getElementById('btn-make-fitbit').onclick=function(){
  flash(this);
  const f=document.getElementById('file-fitbit').files[0];
  if(!f) return setStatus("Upload a Fitbit/time CSV first.", true);

  readCSV(f, rows=>{
    const colTime=pickColumn(rows,["timestamp","time","datetime","date","ActivityMinute"]);
    const colSteps=pickColumn(rows,["steps","value","count","activity","stepcount","Steps"],{fallbackNumeric:true});
    if(!colTime||!colSteps) return setStatus("Couldn’t find time & steps columns.", true);

    const byHour=new Array(24).fill(0);
    const dowSum=new Array(7).fill(0), dowN=new Array(7).fill(0);

    for (const r of rows){
      const d=toDate(r[colTime]); if (!d) continue;
      const v=toNumber(r[colSteps]); if (v===null) continue;
      byHour[d.getHours()] += v;
      const iso = (d.getDay()+6)%7; // Mon=0 … Sun=6
      dowSum[iso]+=v; dowN[iso]+=1;
    }

    // Nightingale: true hours on the circle
    const theta = Array.from({length:24}, (_,h)=> h*15); // 0..345 deg
    const tickVals = Array.from({length:24}, (_,h)=> h*15);
    const tickText = Array.from({length:24}, (_,h)=> String(h)); // 0..23
    Plotly.newPlot('plot5', [{
      type:'barpolar',
      r:byHour,
      theta,
      width:new Array(24).fill(15)
    }], polarLayout("Nightingale Rose: Value by Hour",{
      polar:{angularaxis:{tickmode:'array', tickvals:tickVals, ticktext:tickText}}
    }), config);

    const means = dowSum.map((s,i)=> dowN[i]? s/dowN[i] : 0);
    const labels = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    Plotly.newPlot('plot6', [{
      type:'scatterpolar',
      r:means.concat([means[0]]),
      theta:labels.concat([labels[0]]),
      mode:'lines+markers',
      fill:'toself'
    }], polarLayout("Radar: Mean Steps Share by Day of Week"), config);

    setStatus("Rendered Nightingale (24h) & Radar.");
  });
};

/* ================= Tribolium (cobweb with quadratic map + 1:1 axes) ================= */
document.getElementById('btn-make-trib').onclick=function(){
  flash(this);
  const f=document.getElementById('file-trib').files[0];
  if(!f) return setStatus("Upload a Tribolium CSV first.", true);

  readCSV(f, rows=>{
    const colVal=pickColumn(rows,["adults","count","population","value","n"],{fallbackNumeric:true});
    if(!colVal) return setStatus("Need Adults/Population column.", true);
    const series=toNumberArray(rows.map(r=>r[colVal]));
    if (series.length<6) return setStatus("Need ≥6 numeric rows.", true);

    const x=series.slice(0,-1), y=series.slice(1);
    const n=x.length;
    let Sx=0,Sx2=0,Sx3=0,Sx4=0,Sy=0,Sxy=0,Sx2y=0;
    for (let i=0;i<n;i++){ const xi=x[i], yi=y[i], x2=xi*xi;
      Sx+=xi; Sx2+=x2; Sx3+=x2*xi; Sx4+=x2*x2; Sy+=yi; Sxy+=xi*yi; Sx2y+=x2*yi; }
    function solve3(A,B){ const M=A.map((r,i)=>r.concat([B[i]])); const m=M.length;
      for(let k=0;k<m;k++){ let p=k; for(let i=k+1;i<m;i++) if(Math.abs(M[i][k])>Math.abs(M[p][k])) p=i;
        [M[k],M[p]]=[M[p],M[k]]; const piv=M[k][k]||1e-12;
        for(let j=k;j<=m;j++) M[k][j]/=piv;
        for(let i=0;i<m;i++) if(i!==k){ const f=M[i][k]; for(let j=k;j<=m;j++) M[i][j]-=f*M[k][j]; } }
      return M.map(r=>r[m]);
    }
    const [a,b,c]=solve3([[n,Sx,Sx2],[Sx,Sx2,Sx3],[Sx2,Sx3,Sx4]],[Sy,Sxy,Sx2y]);

    const xmin=Math.min(...x,...y), xmax=Math.max(...x,...y);
    const xs=Array.from({length:400},(_,i)=> xmin+(xmax-xmin)*i/399);
    const fx=xs.map(v=> a+b*v+c*v*v);

    const traces=[
      {x:xs,y:fx,mode:'lines',name:'Quadratic'},
      {x:[xmin,xmax],y:[xmin,xmax],mode:'lines',line:{dash:'dot'},showlegend:false,hoverinfo:'skip',name:'1:1'}
    ];
    function cobweb(x0,steps=30){ let X=x0; const segs=[];
      for(let i=0;i<steps;i++){ const Y=a+b*X+c*X*X; segs.push({x:[X,X],y:[X,Y]}); segs.push({x:[X,Y],y:[Y,Y]}); X=Y; }
      return segs;
    }
    for (const s of cobweb(xmin+0.2*(xmax-xmin)).concat(cobweb(xmin+0.8*(xmax-xmin)))){
      traces.push({x:s.x,y:s.y,mode:'lines',line:{width:1},showlegend:false,hoverinfo:'skip'});
    }

    Plotly.newPlot('plot1', traces, baseLayout("Cobweb (map fit) – Tribolium",{
      xaxis:{title:{text:"x(t)"}}, yaxis:{title:{text:"x(t+1)"}}
    }), config);

    setStatus("Rendered cobweb diagram.");
  });
};

/* ================= Mites (time-series: phase + return) ================= */
document.getElementById('btn-make-mites').onclick=function(){
  flash(this);
  const f=document.getElementById('file-mites').files[0];
  if(!f) return setStatus("Upload a mites time-series CSV first.", true);

  readCSV(f, rows=>{
    const colTime=pickColumn(rows,["time","day","date","week","t","timestamp"],{fallbackNumeric:true});
    const colPrey=pickColumn(rows,["prey","preycount","prey_count","eotetranychus","prey mites"],{fallbackNumeric:true});
    const colPred=pickColumn(rows,["predator","predcount","pred_count","typhlodromus","pred mites"],{fallbackNumeric:true});
    if(!colTime||!colPrey||!colPred) return setStatus("Need columns for time + prey + predator.", true);

    // coerce + sort by time (Date or number)
    let T = rows.map(r=>{
      const tRaw = r[colTime];
      const t = toDate(tRaw) ?? toNumber(tRaw);
      const px = toNumber(r[colPrey]);
      const pd = toNumber(r[colPred]);
      return {t,px,pd};
    }).filter(o=>o.t!==null && o.px!==null && o.pd!==null);

    // if Date objects + numbers mixed, map Dates to millis
    T = T.map(o=>({t: (o.t instanceof Date)? o.t.getTime(): o.t, px:o.px, pd:o.pd}))
         .sort((a,b)=>a.t-b.t);

    if (T.length<6) return setStatus("Too few valid rows (need ≥6).", true);

    const prey=T.map(o=>o.px), pred=T.map(o=>o.pd), idx=T.map((_,i)=>i);

    const line = {x:prey,y:pred,mode:'lines',type:'scatter',line:{width:1.8},name:'path'};
    const pts  = {x:prey,y:pred,mode:'markers',type:'scatter',
                  marker:{size:6,color:idx,colorscale:'Blues',colorbar:{title:'order',x:1.1,thickness:12}},
                  name:'time'};

    Plotly.newPlot('plot2',[line,pts], baseLayout("Phase Plane: Prey vs Predator",{
      xaxis:{title:{text:"Prey(t)"},tickformat:",~s"}, yaxis:{title:{text:"Predator(t)"},tickformat:",~s"}
    }), config);

    function lsFit(x,y){ const n=x.length; let sx=0,sy=0,sxy=0,sx2=0;
      for(let i=0;i<n;i++){sx+=x[i]; sy+=y[i]; sxy+=x[i]*y[i]; sx2+=x[i]*x[i];}
      const b=(n*sxy-sx*sy)/(n*sx2-sx*sx); const a=(sy-b*sx)/n; return {a,b};
    }
    const xt=prey.slice(0,-1), xt1=prey.slice(1);
    const yt=pred.slice(0,-1), yt1=pred.slice(1);

    const dX={x:[Math.min(...xt,...xt1), Math.max(...xt,...xt1)]}; dX.y=dX.x;
    const dY={x:[Math.min(...yt,...yt1), Math.max(...yt,...yt1)]}; dY.y=dY.x;
    const fx=lsFit(xt,xt1), fy=lsFit(yt,yt1);

    Plotly.newPlot('plot3',[
      {x:xt,y:xt1,mode:'markers',name:'Return'},
      {x:dX.x,y:dX.y,mode:'lines',line:{dash:'dot'},showlegend:false,hoverinfo:'skip',name:'1:1'},
      {x:dX.x,y:dX.x.map(v=>fx.a+fx.b*v),mode:'lines',name:'LS fit'}
    ], baseLayout("Return: Prey(t) → Prey(t+1)",{
      xaxis:{title:{text:"Prey(t)"},tickformat:",~s"}, yaxis:{title:{text:"Prey(t+1)"},tickformat:",~s"}
    }), config);

    Plotly.newPlot('plot4',[
      {x:yt,y:yt1,mode:'markers',name:'Return'},
      {x:dY.x,y:dY.y,mode:'lines',line:{dash:'dot'},showlegend:false,hoverinfo:'skip',name:'1:1'},
      {x:dY.x,y:dY.x.map(v=>fy.a+fy.b*v),mode:'lines',name:'LS fit'}
    ], baseLayout("Return: Predator(t) → Predator(t+1)",{
      xaxis:{title:{text:"Predator(t)"},tickformat:",~s"}, yaxis:{title:{text:"Predator(t+1)"},tickformat:",~s"}
    }), config);

    setStatus("Rendered mites phase plane & return maps (time-sorted).");
  });
};

/* clear */
document.getElementById('btn-clear').onclick = ()=>{ flash(document.getElementById('btn-clear')); clearPlots(); };
document.getElementById('btn-clear-files').onclick = ()=>{ flash(document.getElementById('btn-clear-files')); clearFiles(); };
</script>
</body>
</html>




