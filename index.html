<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Coupled Oscillators — Interactive Charts</title>

<!-- Libraries -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root { --pad: 14px; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b0c10; color:#e8e8e8; }
  header { position:sticky; top:0; z-index:20; padding:var(--pad); background:#111217; border-bottom:1px solid #222; }
  h1 { margin:0 0 4px; font-size:20px; }
  .muted { color:#9aa3b2; font-size:12px; }

  /* layout: fixed controls at left, plots scroll independently at right */
  .wrap {
    display:grid; gap:16px; padding:var(--pad);
    grid-template-columns: 340px 1fr;
    grid-template-areas: "controls plots";
  }
  .controls { grid-area:controls; position:sticky; top:72px; align-self:start; }
  .plots    { grid-area:plots; height: calc(100vh - 92px); overflow:auto; }
  @media (max-width: 900px){
    .wrap { grid-template-columns: 1fr; grid-template-areas: "controls" "plots"; }
    .controls { position:static; top:auto; }
    .plots { height:auto; overflow:visible; }
  }

  .card { background:#14161d; border:1px solid #1f2330; border-radius:12px; padding:var(--pad); }
  .card h2 { font-size:16px; margin:0 0 8px; }
  label { display:block; font-size:12px; margin:8px 0 6px; color:#cfd3dc; }
  textarea, input, button {
    width:100%; padding:8px; font:inherit; border-radius:8px;
    border:1px solid #2b3245; background:#0f1117; color:#e8e8e8;
  }
  textarea { min-height:80px; resize:vertical; }
  button { cursor:pointer; transition: background .15s, border-color .15s, box-shadow .15s; }
  button.active { background:#1d2433; border-color:#3a4a6a; box-shadow:0 0 0 2px rgba(110,168,254,.35); }
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }

  /* plots grid with view toggles */
  .toolbar { display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:8px; }
  .viewbar { display:flex; gap:8px; align-items:center; }
  .viewbar button { width:auto; padding-inline:10px; }
  .row { display:grid; gap:16px; grid-template-columns:1fr 1fr; }
  .row.cols1 { grid-template-columns:1fr; }
  .row.cols2 { grid-template-columns:1fr 1fr; }
  .row.cols3 { grid-template-columns:1fr 1fr 1fr; }
  .plot { min-height:520px; width:100%; background:#0f1117; border:1px solid #1f2330; border-radius:12px; }
  .row.cols1 .plot { min-height:640px; }

  /* plot readability */
  .js-plotly-plot .gtitle { white-space:normal !important; }
  .js-plotly-plot .main-svg { overflow:visible !important; }
</style>
</head>
<body>
<header>
  <h1>Coupled Oscillators — Interactive Charts</h1>
  <div class="muted">Header & controls stay fixed. Graphs have their own scroll area. Double-click a plot to fullscreen.</div>
</header>

<div class="wrap">
  <!-- Controls -->
  <div class="card controls">
    <h2>Startup Box — Quick X/Y</h2>
    <label>X values (comma/space/newline-separated)</label>
    <textarea id="xvals" placeholder="e.g., 1, 2, 3, 4"></textarea>
    <label>Y values (same length as X)</label>
    <textarea id="yvals" placeholder="e.g., 2, 4, 3, 6"></textarea>
    <div class="grid-2">
      <button id="btn-scatter">Make Scatter</button>
      <button id="btn-line">Make Connected Line</button>
    </div>

    <hr style="border-color:#1f2330; margin:14px 0;">

    <h2>Upload CSVs</h2>

    <label>Hare–Lynx CSV (flexible headers: Year/Hare/Lynx)</label>
    <input type="file" id="file-hl" accept=".csv"/>

    <label>Predator–Prey (Huffaker-style) CSV (flexible headers: time, prey, predator)</label>
    <input type="file" id="file-pp" accept=".csv"/>

    <label>Fitbit by-minute CSV (flexible: timestamp/time + steps/value)</label>
    <input type="file" id="file-fitbit" accept=".csv"/>

    <label>Tribolium CSV (flexible: t/index/time + Adults/population/value)</label>
    <input type="file" id="file-trib" accept=".csv"/>

    <div class="grid-2" style="margin-top:8px">
      <button id="btn-make-lynx">Phase & Return (HL)</button>
      <button id="btn-make-pp">Phase & Return (Predator–Prey)</button>
    </div>
    <div class="grid-2" style="margin-top:8px">
      <button id="btn-make-fitbit">Rose & Radar</button>
      <button id="btn-make-trib">Cobweb (Tribolium)</button>
    </div>
    <div class="grid-2" style="margin-top:8px">
      <button id="btn-clear">Clear Plots</button>
      <button id="btn-clear-files">Clear Files</button>
    </div>
    <p class="muted" style="margin-top:10px">Use the camera icon on any chart to download a PNG.</p>
  </div>

  <!-- Plots -->
  <div class="card plots">
    <div class="toolbar">
      <div class="viewbar">
        <span class="muted">View:</span>
        <button id="view-1">1-up</button>
        <button id="view-2" class="active" aria-pressed="true">2-up</button>
        <button id="view-3">3-up</button>
      </div>
      <div class="muted">Tip: double-click a plot to fullscreen.</div>
    </div>

    <div id="status" class="muted" style="margin-bottom:8px"></div>

    <div class="row cols2" id="plot-row">
      <div id="plot1" class="plot"></div>
      <div id="plot2" class="plot"></div>
      <div id="plot3" class="plot"></div>
      <div id="plot4" class="plot"></div>
      <div id="plot5" class="plot"></div>
      <div id="plot6" class="plot"></div>
    </div>
  </div>
</div>

<script>
/* ============================ helpers ============================ */
const config = { responsive:true, displaylogo:false };

function setStatus(msg, isError=false){
  const el = document.getElementById("status");
  el.textContent = msg;
  el.style.color = isError ? "#ffb4b4" : "#9aa3b2";
}
function flash(btn, ms=450){ btn.classList.add("active"); setTimeout(()=>btn.classList.remove("active"), ms); }

function toNumber(v){
  if (v===null || v===undefined) return null;
  if (typeof v === "number" && Number.isFinite(v)) return v;
  let s = String(v).trim(); if (!s) return null;
  s = s.replace(/(?<=\d)[\s,](?=\d)/g,"");
  const pct = /%$/.test(s); s = s.replace(/%$/,"");
  const n = Number(s); if (!Number.isFinite(n)) return null;
  return pct ? n/100 : n;
}
const toNumberArray = arr => arr.map(toNumber).filter(v=>v!==null);

function toDate(val){
  if (val===null || val===undefined || val==="") return null;
  if (val instanceof Date && !isNaN(val)) return val;
  if (typeof val === "number"){
    const ms = val >= 1e12 ? val : (val >= 1e9 ? val*1000 : val);
    const d = new Date(ms); return isNaN(d) ? null : d;
  }
  const s = String(val).trim();
  let d = new Date(s); if (!isNaN(d)) return d;
  d = new Date(s.replace(/-/g,'/')); return isNaN(d) ? null : d;
}

function normKey(k){ return String(k||"").toLowerCase().replace(/[^a-z0-9]+/g,"").trim(); }
function pickColumn(rows, opts, {fallbackNumeric=false}={}){
  if (!rows?.length) return null;
  const map={}; Object.keys(rows[0]).forEach(k=>map[normKey(k)]=k);
  for (const o of opts){ const nk=normKey(o); if (nk in map) return map[nk]; }
  if (fallbackNumeric){
    for (const c of Object.keys(rows[0])){
      const vals = rows.slice(0,Math.min(30,rows.length)).map(r=>toNumber(r[c]));
      if (vals.filter(v=>v!==null).length >= Math.ceil(vals.length*0.6)) return c;
    }
  }
  return null;
}

function readCSV(file, cb){
  Papa.parse(file, {
    header:true, skipEmptyLines:true, dynamicTyping:false,
    complete: res => { 
      if (res.errors?.length) setStatus("CSV warnings: "+res.errors[0].message, true);
      else setStatus(`Loaded ${file.name} (${res.data.length} rows).`);
      cb(res.data);
    },
    error: err => setStatus("CSV parse error: "+err, true)
  });
}

function baseLayout(titleText, extra={}){
  return Object.assign({
    title:{ text:titleText, x:0.02, xanchor:"left", font:{size:16}},
    margin:{ t:54, r:30, b:60, l:70 },
    xaxis:{ title:{text:""}, automargin:true, tickfont:{size:11}, titlefont:{size:12} },
    yaxis:{ title:{text:""}, automargin:true, tickfont:{size:11}, titlefont:{size:12} },
    hoverlabel:{ font:{size:11} }
  }, extra);
}
function polarLayout(titleText, extra={}){
  return Object.assign({
    title:{ text:titleText, x:0.02, xanchor:"left", font:{size:16}},
    margin:{ t:54, r:30, b:40, l:30 },
    polar:{ angularaxis:{ direction:"clockwise", tickfont:{size:11} },
            radialaxis:{ tickfont:{size:11}, angle:0, ticks:"outside" } },
    hoverlabel:{ font:{size:11} }
  }, extra);
}

function clearPlots(){ for (let i=1;i<=6;i++) Plotly.purge("plot"+i); setStatus("Cleared plots."); }
function clearFiles(){ ["file-hl","file-pp","file-fitbit","file-trib"].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=""; }); setStatus("Cleared chosen files. (Nothing is uploaded.)"); }

/* ============================ Quick X/Y ============================ */
function parseSeries(text){ if (!text) return []; return toNumberArray(text.replace(/[;,\t\r\n]+/g," ").trim().split(/\s+/)); }
document.getElementById("btn-scatter").onclick = function(){
  flash(this);
  const xs=parseSeries(document.getElementById("xvals").value);
  const ys=parseSeries(document.getElementById("yvals").value);
  if (xs.length!==ys.length || xs.length<2) return setStatus("X and Y must be same length (≥2).", true);
  Plotly.newPlot("plot1", [{x:xs,y:ys,mode:"markers",type:"scatter"}],
    baseLayout("Custom Scatter (X vs Y)", {xaxis:{title:{text:"X"}}, yaxis:{title:{text:"Y"}}}), config);
};
document.getElementById("btn-line").onclick = function(){
  flash(this);
  const xs=parseSeries(document.getElementById("xvals").value);
  const ys=parseSeries(document.getElementById("yvals").value);
  if (xs.length!==ys.length || xs.length<2) return setStatus("X and Y must be same length (≥2).", true);
  Plotly.newPlot("plot1", [{x:xs,y:ys,mode:"lines+markers",type:"scatter"}],
    baseLayout("Custom Connected Line (X vs Y)", {xaxis:{title:{text:"X"}}, yaxis:{title:{text:"Y"}}}), config);
};

/* ======================= Hare–Lynx (phase/return) ======================= */
document.getElementById("btn-make-lynx").onclick = function(){
  flash(this);
  const f=document.getElementById("file-hl").files[0];
  if (!f) return setStatus("Upload a hare–lynx CSV first.", true);
  readCSV(f, rows=>{
    const colYear=pickColumn(rows,["Year","year","date","yr"],{fallbackNumeric:true});
    const colH=pickColumn(rows,["Hare","hare","prey","hares"],{fallbackNumeric:true});
    const colL=pickColumn(rows,["Lynx","lynx","predator","lynxes"],{fallbackNumeric:true});
    if (!colYear||!colH||!colL) return setStatus("Couldn’t find Year/Hare/Lynx columns.", true);
    let T=rows.map(r=>({t:toNumber(r[colYear]), h:toNumber(r[colH]), l:toNumber(r[colL])}))
              .filter(d=>d.t!==null&&d.h!==null&&d.l!==null).sort((a,b)=>a.t-b.t);
    if (T.length<4) return setStatus("Need ≥ 4 numeric rows.", true);
    const t=T.map(d=>d.t), h=T.map(d=>d.h), l=T.map(d=>d.l), idx=t.map((_,i)=>i);

    // phase plane
    const phase = [
      {x:h,y:l,mode:"lines",name:"path",line:{width:1.6}},
      {x:h,y:l,mode:"markers",name:"time",
       marker:{size:5,color:idx,colorscale:"Blues",
               colorbar:{title:"order",x:1.06}}}
    ];
    Plotly.newPlot("plot2", phase,
      baseLayout("Phase Plane: Hare vs Lynx", {
        xaxis:{title:{text:"Hare(t)"}, tickformat:",~s"},
        yaxis:{title:{text:"Lynx(t)"}, tickformat:",~s"}
      }), config);

    // returns
    const ht=h.slice(0,-1), ht1=h.slice(1);
    const lt=l.slice(0,-1), lt1=l.slice(1);
    const diag = (x,y)=>({x:[Math.min(...x,...y), Math.max(...x,...y)],
                          y:[Math.min(...x,...y), Math.max(...x,...y)],
                          mode:"lines", line:{dash:"dot"}, hoverinfo:"skip", showlegend:false});
    Plotly.newPlot("plot3",
      [{x:ht,y:ht1,mode:"markers",name:"Hare"}, diag(ht,ht1)],
      baseLayout("Return: Hare(t) → Hare(t+1)",{
        xaxis:{title:{text:"Hare(t)"}, tickformat:",~s"},
        yaxis:{title:{text:"Hare(t+1)"}, tickformat:",~s"}
      }), config);

    Plotly.newPlot("plot4",
      [{x:lt,y:lt1,mode:"markers",name:"Lynx"}, diag(lt,lt1)],
      baseLayout("Return: Lynx(t) → Lynx(t+1)",{
        xaxis:{title:{text:"Lynx(t)"}, tickformat:",~s"},
        yaxis:{title:{text:"Lynx(t+1)"}, tickformat:",~s"}
      }), config);

    setStatus("Rendered Hare–Lynx phase plane and return maps.");
  });
};

/* =========== Predator–Prey (Huffaker-style) phase/return =========== */
document.getElementById("btn-make-pp").onclick = function(){
  flash(this);
  const f=document.getElementById("file-pp").files[0];
  if (!f) return setStatus("Upload a predator–prey CSV first.", true);
  readCSV(f, rows=>{
    const colT=pickColumn(rows,["time","t","step","index","day","week"],{fallbackNumeric:true});
    const colPrey=pickColumn(rows,["prey","preycount","prey_n","preys"],{fallbackNumeric:true});
    const colPred=pickColumn(rows,["predator","predators","predcount","pred_n"],{fallbackNumeric:true});
    if (!colT||!colPrey||!colPred) return setStatus("Need columns for time, prey, predator.", true);

    let T=rows.map(r=>({t:toNumber(r[colT]), x:toNumber(r[colPrey]), y:toNumber(r[colPred])}))
              .filter(d=>d.t!==null&&d.x!==null&&d.y!==null).sort((a,b)=>a.t-b.t);
    if (T.length<6) return setStatus("Too few rows for predator–prey.", true);

    const t=T.map(d=>d.t), prey=T.map(d=>d.x), pred=T.map(d=>d.y), idx=t.map((_,i)=>i);

    // phase plane (raw counts with SI ticks)
    Plotly.newPlot("plot2",
      [
        {x:prey,y:pred,mode:"lines",name:"path",line:{width:1.6}},
        {x:prey,y:pred,mode:"markers",name:"time",
         marker:{size:5,color:idx,colorscale:"Blues",colorbar:{title:"order",x:1.06}}}
      ],
      baseLayout("Phase Plane: Prey vs Predator",{
        xaxis:{title:{text:"Prey(t)"}, tickformat:",~s"},
        yaxis:{title:{text:"Predator(t)"}, tickformat:",~s"}
      }), config);

    // returns (+ y=x line + LS fit)
    const xr=prey.slice(0,-1), yr=prey.slice(1);
    const xl=pred.slice(0,-1), yl=pred.slice(1);
    function diag(x,y){ return {x:[Math.min(...x,...y), Math.max(...x,...y)],
                                y:[Math.min(...x,...y), Math.max(...x,...y)],
                                mode:"lines", line:{dash:"dot"}, hoverinfo:"skip", showlegend:false}; }
    function lsfit(x,y){
      const n=x.length; let sx=0, sy=0, sxx=0, sxy=0;
      for (let i=0;i<n;i++){ sx+=x[i]; sy+=y[i]; sxx+=x[i]*x[i]; sxy+=x[i]*y[i]; }
      const b=(n*sxy-sx*sy)/(n*sxx-sx*sx); const a=(sy-b*sx)/n;
      const xs=[Math.min(...x), Math.max(...x)]; const ys=xs.map(v=>a+b*v);
      return {xs,ys,a,b};
    }
    const fh=lsfit(xr,yr), fl=lsfit(xl,yl);

    Plotly.newPlot("plot3",
      [
        {x:xr,y:yr,mode:"markers",name:"Return"},
        diag(xr,yr),
        {x:fh.xs, y:fh.ys, mode:"lines", name:"LS fit", line:{width:2}}
      ],
      baseLayout("Return: Prey(t) → Prey(t+1)",{
        xaxis:{title:{text:"Prey(t)"}, tickformat:",~s"},
        yaxis:{title:{text:"Prey(t+1)"}, tickformat:",~s"}
      }), config);

    Plotly.newPlot("plot4",
      [
        {x:xl,y:yl,mode:"markers",name:"Return"},
        diag(xl,yl),
        {x:fl.xs, y:fl.ys, mode:"lines", name:"LS fit", line:{width:2}}
      ],
      baseLayout("Return: Predator(t) → Predator(t+1)",{
        xaxis:{title:{text:"Predator(t)"}, tickformat:",~s"},
        yaxis:{title:{text:"Predator(t+1)"}, tickformat:",~s"}
      }), config);

    setStatus("Rendered predator–prey phase plane and return maps.");
  });
};

/* ======================= Fitbit (rose + radar) ======================= */
document.getElementById("btn-make-fitbit").onclick = function(){
  flash(this);
  const f=document.getElementById("file-fitbit").files[0];
  if (!f) return setStatus("Upload a Fitbit/time CSV first.", true);
  readCSV(f, rows=>{
    const colTime=pickColumn(rows,["timestamp","time","datetime","date","activityminute","starttime"],{fallbackNumeric:false});
    const colSteps=pickColumn(rows,["steps","value","count","activity","stepcount"],{fallbackNumeric:true});
    if (!colTime||!colSteps) return setStatus("Couldn’t find time & steps columns.", true);

    // accumulate
    const byHour=new Array(24).fill(0);
    const dowSum=new Array(7).fill(0), dowN=new Array(7).fill(0);
    for (const r of rows){
      const d=toDate(r[colTime]); if (!d) continue;
      const s=toNumber(r[colSteps]); if (s===null) continue;
      byHour[d.getHours()]+=s;
      const w=(d.getDay()+6)%7; dowSum[w]+=s; dowN[w]+=1;
    }

    // Nightingale rose — 24 hours, hour labels (no degrees)
    const theta = [...Array(24).keys()].map(h=>h*15); // degrees, but…
    const hourLabels = Array.from({length:24},(_,h)=>{
      const ampm = h===0? "12a" : (h<12? `${h}a` : (h===12? "12p" : `${h-12}p`));
      return ampm;
    });

    Plotly.newPlot("plot5",
      [{type:"barpolar", r:byHour, theta:theta, width:new Array(24).fill(360/24)}],
      polarLayout("Nightingale Rose: Value by Hour",{
        polar:{ angularaxis:{direction:"clockwise", rotation:90, // put 12 at top
                             tickmode:"array",
                             tickvals: theta,
                             ticktext: hourLabels },
                radialaxis:{ticks:"outside"} }
      }), config);

    // Radar — mean share by weekday (normalize by per-day totals)
    const total = dowSum.reduce((a,b)=>a+b,0) || 1;
    const share = dowSum.map(s=> (s/total)*100);
    const labels = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    Plotly.newPlot("plot6",
      [{type:"scatterpolar",
        r: share.concat([share[0]]),
        theta: labels.concat([labels[0]]),
        mode:"lines+markers", fill:"toself"}],
      polarLayout("Radar: Mean Steps Share by Day of Week"), config);

    setStatus("Rendered Nightingale rose (24h) and radar.");
  });
};

/* ======================= Tribolium (cobweb) ======================= */
document.getElementById("btn-make-trib").onclick = function(){
  flash(this);
  const f=document.getElementById("file-trib").files[0];
  if (!f) return setStatus("Upload a Tribolium CSV first.", true);
  readCSV(f, rows=>{
    const colT=pickColumn(rows,["t","time","step","index"],{fallbackNumeric:true});
    const colVal=pickColumn(rows,["adults","count","population","value","n"],{fallbackNumeric:true});
    if (!colT||!colVal) return setStatus("Couldn’t find t & Adults columns.", true);

    const series = toNumberArray(rows.map(r=>r[colVal]));
    if (series.length<3) return setStatus("Need ≥ 3 numeric rows.", true);
    const x=series.slice(0,-1), y=series.slice(1);

    // quadratic fit to map y = a + b x + c x^2
    const n=x.length; let Sx=0,Sx2=0,Sx3=0,Sx4=0,Sy=0,Sxy=0,Sx2y=0;
    for (let i=0;i<n;i++){ const xi=x[i], yi=y[i], x2=xi*xi;
      Sx+=xi; Sx2+=x2; Sx3+=x2*xi; Sx4+=x2*xi*xi; Sy+=yi; Sxy+=xi*yi; Sx2y+=x2*yi; }
    function solve3(A,B){ const M=A.map((r,i)=>r.concat([B[i]])); const m=M.length;
      for(let k=0;k<m;k++){ let p=k; for(let i=k+1;i<m;i++) if(Math.abs(M[i][k])>Math.abs(M[p][k])) p=i;
        [M[k],M[p]]=[M[p],M[k]]; const piv=M[k][k]||1e-12;
        for(let j=k;j<=m;j++) M[k][j]/=piv;
        for(let i=0;i<m;i++) if(i!==k){ const f=M[i][k]; for(let j=k;j<=m;j++) M[i][j]-=f*M[k][j]; } }
      return M.map(r=>r[m]);
    }
    const [a,b,c] = solve3([[n,Sx,Sx2],[Sx,Sx2,Sx3],[Sx2,Sx3,Sx4]],[Sy,Sxy,Sx2y]);

    const xmin=Math.min(...x,...y), xmax=Math.max(...x,...y);
    const xs=Array.from({length:400},(_,i)=> xmin+(xmax-xmin)*i/399);
    const fx=xs.map(v=> a+b*v+c*v*v);

    const traces=[
      {x:xs,y:fx,mode:"lines",name:"Quadratic"},
      {x:[xmin,xmax],y:[xmin,xmax],mode:"lines",line:{dash:"dot"},hoverinfo:"skip",showlegend:false}
    ];
    function cobweb(x0,steps=30){ let X=x0; const segs=[];
      for(let i=0;i<steps;i++){ const Y=a+b*X+c*X*X; segs.push({x:[X,X],y:[X,Y]}); segs.push({x:[X,Y],y:[Y,Y]}); X=Y; }
      return segs;
    }
    for (const s of cobweb(xmin+0.2*(xmax-xmin)).concat(cobweb(xmin+0.8*(xmax-xmin))))
      traces.push({x:s.x,y:s.y,mode:"lines",line:{width:1},hoverinfo:"skip",showlegend:false});

    Plotly.newPlot("plot1", traces,
      baseLayout("Cobweb (map fit) – Tribolium",{ xaxis:{title:{text:"x(t)"}}, yaxis:{title:{text:"x(t+1)"}} }),
      config);

    setStatus("Rendered cobweb diagram.");
  });
};

/* ======================= View toggles + fullscreen ======================= */
const rowEl=document.getElementById("plot-row");
const btnV1=document.getElementById("view-1");
const btnV2=document.getElementById("view-2");
const btnV3=document.getElementById("view-3");
const vbtns=[btnV1,btnV2,btnV3];
function setCols(n){ rowEl.classList.remove("cols1","cols2","cols3"); rowEl.classList.add(`cols${n}`); }
function setActive(el){ vbtns.forEach(b=>b.classList.remove("active")); el.classList.add("active"); }
btnV1.onclick=()=>{ setCols(1); setActive(btnV1); };
btnV2.onclick=()=>{ setCols(2); setActive(btnV2); };
btnV3.onclick=()=>{ setCols(3); setActive(btnV3); };
setCols(2);  // default

// very light fullscreen: clone figure JSON on dblclick
for (let i=1;i<=6;i++){
  const id="plot"+i, el=document.getElementById(id);
  el.addEventListener("dblclick", ()=>{
    const wrap=document.createElement("div");
    wrap.style.cssText="position:fixed;inset:0;background:rgba(11,12,16,.98);z-index:9999;padding:10px;display:grid;place-items:center";
    wrap.innerHTML=`<div style="position:fixed;top:10px;right:12px">
      <button style="background:#14161d;color:#e8e8e8;border:1px solid #2b3245;padding:8px 10px;border-radius:8px">Close (Esc)</button>
    </div><div style="width:min(1200px,95vw);height:min(90vh,900px)"><div id="fs"></div></div>`;
    document.body.appendChild(wrap);
    const gd=el, data=(gd.data?JSON.parse(JSON.stringify(gd.data)):[]), layout=(gd.layout?JSON.parse(JSON.stringify(gd.layout)):{});
    Plotly.newPlot("fs", data, layout, {responsive:true,displaylogo:false});
    const close=()=>{ document.removeEventListener("keydown",esc); wrap.remove(); };
    const esc=(e)=>{ if(e.key==="Escape") close(); };
    wrap.querySelector("button").onclick=close; document.addEventListener("keydown",esc);
  });
}

/* ======================= clear buttons ======================= */
document.getElementById("btn-clear").onclick = function(){ flash(this); clearPlots(); };
document.getElementById("btn-clear-files").onclick = function(){ flash(this); clearFiles(); };
</script>
</body>
</html>






